<!DOCTYPE html>
<!-- saved from url=(0079)https://www.idtechproducts.com/hosted-files/tools/encryptiondecryptiontool.html -->
<html class="ui-mobile"><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252"><!--<base href="https://www.idtechproducts.com/hosted-files/tools/encryptiondecryptiontool.html">--><base href=".">
<script>


var MODE = ""; // User-selected operation ("encrypt", "ipek", "pek", etc.). See handleSelection().
var KEYMODE = "datakey"; // Default is data key. See handleKeyVariantSelection().
var LAST_IPEK = "";
var LAST_BDK = "0123456789ABCDEFFEDCBA9876543210";
var LAST_SESSION_KEY = "";

document.addEventListener('DOMContentLoaded', function () {
    	document.getElementById('encryptButton').addEventListener( 'click', encryptAction );
    	document.getElementById('dCalc').addEventListener( 'click', deriveAction );
    	document.getElementById('decryptButton').addEventListener( 'click', decryptAction );
    	document.getElementById('clearButton').addEventListener( 'click', clearAction );   
    	document.getElementById('selection').addEventListener( 'change', handleSelection );
    	document.getElementById('keyvariant').addEventListener( 'change', handleKeyVariantSelection );
	setVisibility( "derive", "hidden" );
	executeURLQuery( );
});


function encryptAction() { 

	switch( MODE ) {
	
		case "ipek" : 
		{
				var key = getUserInput( "key" );
				var data= getUserInput( "data" );

				if ( !key || !data )
					return; // nothing to do!

				var ipek = createIPEK( key, data );
				writeOutput( ipek ); // show ipek
				LAST_IPEK =  ipek; // cache some recent values...
				LAST_BDK = key;
				return;
		}

		case "encrypt": 	doEncryption( true ); 
					var outputNode = document.querySelector("#output");

					// show an ASCII tooltip of the result
					if ( outputNode.value != "")
						setTooltip( outputNode, hexToText( outputNode.value) );

					return;

		case "hmac":		doHMAC( false );  // false means no verbose output
					return;

		case "hmacVerbose":	document.querySelector("#verboseOutput").innerHTML = "";
					doHMAC( true ); // true means verbose output
					return;

		case "sha1":		doSHA( "SHA-1" );
					return;

		case "sha256":		doSHA( "SHA-256" );
					return;

		case "pek" :  		LAST_SESSION_KEY = produceSessionKey(); 
					return;

		case "" : 		writeOutput( "Nothing to do. Select a mode of operation." ); return;
	}
}

function fieldEmpty( fieldArray ) {

	for (var i=0; i < fieldArray.length; i++)
		if ( fieldArray[i] == "" ) // empty
			return true;
	return false;
}

// When user clicks Derive Key...
function deriveAction() {

	var dBDK = document.querySelector("#dBDK").value;
	var dKSN = document.querySelector("#dKSN").value;
	
	// sanity check the inputs
	if ( fieldEmpty( [ dBDK, dKSN ] ) ) {
		alert(" A field is blank. ");
		return;
	}
	if ( dBDK.replace(/\s/g,"").length != 32 ||
		dKSN.replace(/\s/g,"").length != 20 ) {
	
		alert( " Key must be 16 bytes long and KSN must be 10 bytes." );
		return;
	}
	
	var ipek = createIPEK( dBDK, dKSN ); // Always start with IPEK
  console.log("ipek :" + ipek );
  console.log("dKSN :" + dKSN );

	var sk;

	if ( KEYMODE == "datakey" )
		sk = createDataKeyHex( ipek, dKSN );

	if ( KEYMODE == "pinkey" )
		sk = createPINKeyHex( ipek, dKSN );

	if ( KEYMODE == "mackey" )
		sk = createMACKeyHex( ipek, dKSN );

   	document.querySelector("#key").value = sk;
}
// This gets called when user is supplying IPEK (not BDK)
// and wants to derive session key.
function produceSessionKey() {

	var ipek= getUserInput( "key" );
	var data= getUserInput( "data" ); // data field contains KSN

	if ( fieldEmpty( [ipek, data] ) ) {
		alert( "A field was empty. Check your inputs." );
		return; // nothing to do!
	}

	var sk = createDataKeyHex( ipek, data );

	writeOutput( sk );

	return sk;
}

// PRODUCE PIN KEY VARIANT
function createPINKeyHex(ipek, ksn) {

    var derivedPEK = deriveKeyHex( ipek, ksn ); // derive DUKPT basis key

    var CBC = 1;  		 // cipher block chaining enabled
    var iv = "\0\0\0\0\0\0\0\0"; // initial vector
    var variantMask = "00000000000000FF00000000000000FF"; // PIN variant
	
    var maskedPEK = XORdataHex( variantMask, derivedPEK ); // apply mask
    return maskedPEK;
}

// PRODUCE MAC KEY VARIANT
function createMACKeyHex(ipek, ksn) {

    var derivedPEK = deriveKeyHex( ipek, ksn ); // derive DUKPT basis key

    var CBC = 1;  		 // cipher block chaining enabled
    var iv = "\0\0\0\0\0\0\0\0"; // initial vector
    var variantMask = "000000000000FF00000000000000FF00"; // MAC variant
	
    var maskedPEK = XORdataHex( variantMask, derivedPEK ); // apply mask
    return maskedPEK;
}

function doHMAC( verbose ) {

	var hmac = "";

	try {
		var hashKeyInput = document.querySelector("#key" ).value.replace(/\s/g,'');
		var dataValue    = document.querySelector("#data").value.replace(/\s/g,'');

		if ( fieldEmpty( [ hashKeyInput, dataValue ] ) ) {
			alert( "Field is empty. Nothing to do." );
			return "";
		}

		var hmacObj = new jsSHA( "SHA-256","HEX" );
		hmacObj.setHMACKey( hashKeyInput, "HEX" );
		hmacObj.update( dataValue );

		hmac = hmacObj.getHMAC( "HEX" ); // get hash

		document.querySelector("#output").value = hmac.toUpperCase(); // show the hash

		if ( verbose ) 
			showHMACVerboseOutput( hashKeyInput, dataValue );
	}
	catch(e) {
		document.querySelector("#output").value = e.message;
	}

	return hmac;
}

function getPads( padChar, howMany ) {

	return (new Array( howMany + 1 )).join( padChar );
}

function showHMACVerboseOutput( key, data ) {

	var spanHeader = "<br/><span style=\"font-family:Times,serif;font-size:16.0pt;\">";
	var spanClose = "</span><br/>";

	var hmacFormula = "H( (K' &oplus; opad) &#8214; H( (K' &oplus; ipad) &#8214; m) )";


	// ====== Show the HMAC formula ======
	writeOutputVerbose( "<br/><br/>HMAC is calculated according to:" );
	writeOutputVerbose( spanHeader + "<i>" + hmacFormula + "</i>" + spanClose );


	// ====== Show the gritty details ======

	var paddedKey = key + getPads( "00", 64 - key.length/2 );

	// Show padded key (K')
	writeOutputVerbose(  "K' is <br/>" + paddedKey  );

	// Show ipad
	var ipad = getPads( "36", 64 );
	writeOutputVerbose( "ipad is <br/>" + ipad );

	// Show K' ^ ipad
	var ipaddedKey = XORdataHex( ipad, paddedKey );
	writeOutputVerbose( "K' &oplus; ipad is <br/>" + ipaddedKey ); 

	// Show m
	var m = data;
	writeOutputVerbose( "m is <br/>" + m );

	// Show K' ^ ipad + m
	var ipaddedKeyPlusM = ipaddedKey + m;
	writeOutputVerbose( "K' &oplus; ipad &#8214; m is <br/>" +ipaddedKeyPlusM );

	// Show H( K' ^ ipad + m )
	var hashObj = new jsSHA( "SHA-256" , "HEX" );
	hashObj.update( ipaddedKeyPlusM );
	var hash = hashObj.getHash( "HEX" ); // get hash
	writeOutputVerbose( "H(K' &oplus; ipad &#8214; m) is <br />" + hash );

	// Show opad
	var opad = getPads( "5C", 64 );
	writeOutputVerbose( "opad is <br/>" + opad );

	// Show K' ^ opad
	var opaddedKey = XORdataHex( opad, paddedKey );
	writeOutputVerbose( "K' &oplus; opad is <br/>" + opaddedKey ); 

	// Show (K' ^ opad) + previous hash
	var finalArgument = opaddedKey + hash;
	writeOutputVerbose( "(K' &oplus; opad) &#8214; H( (K' &oplus; ipad) &#8214; m) is <br/>" + finalArgument ); 

	// Show H( (K' ^ opad) + previous hash )
	hashObj = new jsSHA( "SHA-256" , "HEX" );
	hashObj.update( finalArgument );
	var HMAC = hashObj.getHash( "HEX" ); // get hash
	writeOutputVerbose( hmacFormula + " is <br/>" + HMAC );
	writeOutputVerbose("<br/><br/>");

}

function doSHA( type ) {
	
	var hash = "";

	try {
		var dataValue    = document.querySelector("#data").value.replace(/\s/g,'');

		if ( fieldEmpty( [ dataValue ] ) ) {
			alert( "Data field is empty. Nothing to do." );
			return "";
		}

		var hashObj = new jsSHA( type,"HEX" );
		hashObj.update( dataValue );

		hash = hashObj.getHash( "HEX" ); // get hash

		document.querySelector("#output").value = hash.toUpperCase(); // show the hash
		
	}
	catch(e) {
		document.querySelector("#output").value = e.message;
	}

	return hash;
}



function numericArrayToHexstring( ba ) {

	var st = "";
	for (var i=0; i < ba.length; i++) {
		var item = ba[i];
		var hex = item.toString(16);
		if ( hex.length < 2) hex = "0" + hex;
		st += hex;
	}
	return st;	
}

// AES
// Encrypts or decrypts.
// Pass true (3rd arg) for encrypt, false for decrypt.
// Pass hex-string key and data.
// Output: Writes hex to UI window and returns hex string.
function encryptAES( key, data, encrypt ) {

	// convert to integer arrays for AES
	var keyArray  = hexstringToNumericArray( key );
	var dataArray = hexstringToNumericArray( data);

	if ( keyArray.length != 16) {
		writeOutput( "Key must be 16 bytes for AES." );
		return -1;
	}	

	while ( dataArray.length % 16 ) 
		dataArray.push( 0 );  // pad with zeroes

	// The initialization vector, which can be null
	var iv = null;

	// We will use CBC mode:
	var aesCbc = new aesjs.ModeOfOperation.cbc( keyArray, iv);

	var accumulate = function( a, b ) {
		for (var i = 0; i < b.length; i++)
			a.push( b[i] );
	}
	
	var bytes = [];

	for ( var i = 0; i < dataArray.length; i += 16 ) {

		var result = encrypt? aesCbc.encrypt( dataArray.slice( i, i+16 ) ) :
			     aesCbc.decrypt( dataArray.slice( i, i+16 ) );
		accumulate( bytes, result );
	}

	// Convert our bytes back into text
	var hex = numericArrayToHexstring( bytes );

	writeOutput( hex );

	return hex;
}


// Encrypt OR decrypt using TDES.
// The key and data should be hex strings.
// The third argument should be boolean: 
// true (for encrypt) or false (decrypt).
// If the key is 8 bytes, single-DES will occur.
// If binaryKey.length > 8, TDES will occur.
function encryptTDES( key, data, encryptTrueFalse ) {

  console.log("============================================");
  console.log("DECRYPT KEY: " + key );

	var CBC = 1;  		     // cipher block chaining enabled
	var ECB = 0;
	//var iv = String.fromCharCode(0x00, 0x00, 0x3B, 0x1D, 0x16, 0x48, 0x68, 0xB0 ); // 54D8282B4AAB78CC  1D25423532323830
	//var iv = String.fromCharCode(0x6F, 0xED, 0x1A, 0x19, 0x72, 0x9B, 0x4B, 0xFC ); // 54D8282B4AAB78CC  3B35323238303330
	//var iv = String.fromCharCode(0x?17, 0xBC, 0x54, 0x8E, 0x5B, 0xC1, 0xD1, 0xF0? ); // 2C8F63B76DF1E4C1  3B33373936303531
	//var iv = String.fromCharCode(0x17, 0xBC, 0x54, 0x8E, 0x5B, 0xC1, 0xD1, 0xF0 ); // 54D8282B4AAB78CC  3B35323238303330
	//var iv = String.fromCharCode(0x07, 0x2C 0xEB, 0xCE, 0xB8, 0xFD, 0xC5, 0xB8 ); // 3C18DBFE8DC8F38A  3B34303035353632
	//var iv = String.fromCharCode(0x07, 0x2C, 0xEB, 0xCE, 0xB8, 0xFD, 0xC5, 0xB8 ); // 54D8282B4AAB78CC  3B35323238303330
	//var iv = String.fromCharCode(0xDD, 0x23, 0x3D, 0xF1, 0xEC, 0x77, 0x75, 0x6A );
	var iv = "\0\0\0\0\0\0\0\0"; // initial vector

	try {
		// convert to binary
		var binaryKey = hexstringToData( key );
		var binaryData= hexstringToData( data );

		// data should be a multiple of 8 bytes
		while( binaryData.length % 8 )
			binaryData += "\0";

		var cipher = des( binaryKey, 
			  binaryData,
			  encryptTrueFalse,
			  CBC,
			  iv,
			  null );

		writeOutput( dataToHexstring( cipher ) );
	}
	catch(e) {
		console.log("encryptTDES() error: " + e.toString() );
		writeOutput("encryptTDES() error: " + e.toString() );
	}

	// return the hex-string
	return cipher;
}


// Pass true for encryption, false for decryption.
// This routine marshalls the user's input and
// passes it to the appropriate algorithm.
// We expect all input to be hex strings.
function doEncryption( encryptTrueFalse ) {

	var key = getUserInput( "key" ).replace(/\s/g,""); // remove spaces
	var data= getUserInput( "data" ).replace(/\s/g,"");

	if ( !key || !data )
		return; // nothing to do!

	// If user supplied 16-byte key (32 hex nibbles),
	// auto-expand it to 24 bytes for TDES (only):
	if ( key.length == 32 && getEncryptionMode() != "AES" )
		key = EDE3KeyExpand( key );

	return getEncryptionMode() == "AES" ? encryptAES( key, data, encryptTrueFalse ) :
		encryptTDES( key, data, encryptTrueFalse );
}

function getUserInput( id ) {

	function isValidHex( s ) { return !s.match(/[^0-9a-fA-F]/); }

	var node = document.querySelector( "#" + id );
	var item = node.value.replace(/\s/g,"");

	if ( !item ) {
		node.value = "Please enter a value for " + id + ".";
		return false;
	}
	if ( !isValidHex( item ) ) {
		node.value = "Not valid hex data. Please enter hex characters only.";
		return false;
	}
	if ( item.length & 1 ) {
		node.value = "Invalid-length data. Odd number of nibbles.";
		return false;
	}
	return item;
}


function decryptAction() {

	doEncryption( false );

	var outputNode = document.querySelector("#output");

	// show an ASCII tooltip of the result
	if ( outputNode.value != "")
		setTooltip( outputNode, hexToText( outputNode.value) );

	// Just for fun, write the ASCII version to the console:
	console.log( hexToText( outputNode.value) );
}

function clearAction() {
	document.querySelector("#key").value = "";
	document.querySelector("#data").value = "";
	document.querySelector("#output").value = "";
	document.querySelector("#verboseOutput").innerHTML = "";
	
}

function setTooltip( node, tip ) {
	node.setAttribute( "title" , tip );
}

function setVisibility( selector, state ) {
	document.querySelector("#" + selector ).style.visibility = state;
}

// This handles the top dropdown-list UI element.
// This method also manages the UI dynamism.
// That is, it changes the button names dynamically, etc.
function handleSelection() {

	MODE = document.getElementById("selection").value;

	var actionButton = document.querySelector( "#encryptButton" );

	clearVerboseOutput(); // clear any leftover verbose output 

	if ( MODE == "ipek" ) {
		setVisibility( "key", "visible" );
		setHeads( [ "BDK:", "KSN:" , "Output:" ] );
		document.querySelector( "#key" ).value = LAST_BDK;
		actionButton.value = "Generate IPEK";
		setVisibility( "decryptButton", "hidden" );
		setVisibility( "modeControl", "hidden" );
		setVisibility( "derive", "hidden" );
		
		if ( typeof $ != "undefined" && "mobile" in $ ) 
			$("#encryptButton").text("Generate IPEK");
				
 	}
	if ( MODE == "encrypt" || MODE == "" ) {
		setVisibility( "key", "visible" );
		setHeads( [ "Key:", "Data to encrypt or decrypt:"  , "Output:" ] );
		document.querySelector( "#data" ).value = ""; 
		document.querySelector( "#key" ).value = LAST_SESSION_KEY;
		actionButton.value = " Encrypt ";
		setVisibility( "decryptButton", "visible" );
		setVisibility( "modeControl", "visible" );   // Use AES?
		setVisibility( "derive", "visible" );
		if ( typeof $ != "undefined" && "mobile" in $ ) 
			$("#encryptButton").text("Encrypt");				
 	}

	if ( MODE == "pek" ) {
		setVisibility( "key", "visible" );
		setHeads( [ "IPEK:", "KSN:" , "Output:"  ] );
		document.querySelector( "#key" ).value = LAST_IPEK;
		actionButton.value = " Derive Session Key ";
		setVisibility( "decryptButton", "hidden" );
		setVisibility( "modeControl", "hidden" );
		setVisibility( "derive", "hidden" );
		if ( typeof $ != "undefined" && "mobile" in $ ) 
			$("#encryptButton").text(" Derive Session Key ");
								
 	}

	if ( MODE == "hmac" || MODE == "hmacVerbose" ) {
		setVisibility( "key", "visible" );
		setHeads( [ "Key:", "Data:" , "HMAC:"  ] );
		actionButton.value = " Hash ";
		setVisibility( "decryptButton", "hidden" );
		setVisibility( "modeControl", "hidden" );  // hide AES checkbox
		setVisibility( "derive", "visible" );
		if ( typeof $ != "undefined" && "mobile" in $ ) 
			$("#encryptButton").text(" Hash ");
	}

	if ( MODE == "sha256" || MODE == "sha1" ) {
		setHeads( [ "", "Data:" , MODE == "sha256"? "SHA-256:" : "SHA-1"  ] );
		actionButton.value = " Hash ";
		setVisibility( "decryptButton", "hidden" );
		setVisibility( "modeControl", "hidden" );  // hide AES checkbox
		setVisibility( "derive", "hidden" );
		setVisibility( "key", "hidden" );
		if ( typeof $ != "undefined" && "mobile" in $ ) 
			$("#encryptButton").text(" Hash ");
	}
	
	// turn off ASCII tooltip, if it was on:
	setTooltip( document.querySelector("#output"), null );

	// zero the Output:
	document.querySelector( "#output" ).value = "";
}

function handleKeyVariantSelection() {

	// KEYMODE will be one of 'datakey', 'mackey', or 'pinkey'
	KEYMODE = document.getElementById("keyvariant").value;
	
}

function setHeads( values ) {
	document.querySelector("#keyheader").innerHTML  = values[0];
	document.querySelector("#dataheader").innerHTML = values[1];
	document.querySelector("#outputheader").innerHTML = values[2];
}

function writeOutput( msg ) {

	var node = document.querySelector( "#output" );
	node.value = msg;
}

function writeOutputVerbose( msg ) {
	var node = document.querySelector( "#verboseOutput" );
	node.innerHTML += msg + "<br/><br/>";
}

function clearVerboseOutput() {
	var node = document.querySelector( "#verboseOutput" );
	node.innerHTML = "";
}

function getEncryptionMode() {
	return document.querySelector("#encryptionMode").checked ? "AES" : "TDES";
}

// Use this to convert "0123DEF01234" (hex string) to
// binary data based on 0x01 0x23 0xDE 0xF0 0x12 0x34
function hexstringToData( hex ) {

	hex = hex.replace(/\s/g,""); // eliminate spaces

   	var keyar = hex.match(/../g); // break into array of doublets
 
   	var s="";  // holder for our return value

   	for(var i=0;i<keyar.length;i++) 
      		s += String.fromCharCode( Number( "0x" + keyar[i] ) );

   	return s;
}

function hexstringToNumericArray( hex ) {

	hex = hex.replace(/\s/g,""); // eliminate spaces

   	var keyar = hex.match(/../g); // break into array of doublets
 
   	var s = [];  // holder for our return value

   	for(var i=0;i<keyar.length;i++) 
      		s.push( Number( "0x" + keyar[i] ) );

   	return s;
}

// Use this to convert binary data (in string variable 'd') to hex string
function dataToHexstring( d ) {
	var hex = "";
	for ( var i = 0; i < d.length; i++) {
		var h = (d.charCodeAt( i )).toString( 16 );
		if (h.length < 2) h = "0" + h;
		hex += h;
	}
	return hex.toUpperCase();	
}

// This takes 2 binary strings and returns a binary string.
function XORdata( data1, data2 ) {

	if ( data1.length < data2.length) {
			
		while (data1.length < data2.length)
			data1 = "\0" + data1; // prepend with nulls
	}

     	if ( data1.length > data2.length) {
			
		while (data1.length > data2.length)
			data2 = "\0" + data2; // prepend with nulls
	}

	var output = "";

	for (var i = 0; i < data1.length; i++) {
		var result = data1.charCodeAt( i ) ^ data2.charCodeAt( i );
		output += String.fromCharCode( result );
	}

	return output;
}	

function XORdataHex( d1,d2 ) {

	var data1 = hexstringToData( d1 );
        var data2 = hexstringToData( d2 );

	if ( data1.length < data2.length) {
			
		while (data1.length < data2.length)
			data1 = "\0" + data1; // prepend with nulls
	}

     	if ( data1.length > data2.length) {
			
		while (data1.length > data2.length)
			data2 = "\0" + data2; // prepend with nulls
	}

	var output = "";

	for (var i = 0; i < data1.length; i++) {
		var result = data1.charCodeAt( i ) ^ data2.charCodeAt( i );
		output += String.fromCharCode( result );
	}

	return dataToHexstring( output );
}	

// This takes 2 binary strings and returns a binary string.
function ANDdata( data1, data2 ) {

	if ( data1.length < data2.length) {
			
		while (data1.length < data2.length)
			data1 = "\0" + data1; // prepend with nulls
	}

     	if ( data1.length > data2.length) {
			
		while (data1.length > data2.length)
			data2 = "\0" + data2; // prepend with nulls
	}

	var output = "";

	for (var i = 0; i < data1.length; i++) {
		var result = data1.charCodeAt( i ) & data2.charCodeAt( i );
		output += String.fromCharCode( result );
	}

	return output;
}	

// Typically, this function receives a 16-byte key string
// and lengthens it to 24 bytes.
function EDE3KeyExpand( key ) {

	return key + key.substring( 0, key.length / 2 );
}

// Utility function: Convert hex to ASCII
function hexToText(h) {
	
	function isASCII(s) {
   		return s >= 32 && s < 127;
	}

  h = h.replace(/\s/g,""); // eliminate spaces

  var SPECIAL = "." ; //String.fromCharCode(9744);
  var symbols = h.match(/../g);
  var output = [];
  for (var i = 0; i < symbols.length; i++) {
    var s = symbols[i];
    var s_decimal = Number("0x"+s) * 1;
    output.push( isASCII(s_decimal)? 
		String.fromCharCode(s_decimal) : SPECIAL );
    
  }
  return output.join("");
}


function getMaskedKSN( ksn ) {

	var mask = "0000FFFFFFFFFFE00000";
	mask = hexstringToData( mask ); // make it binary

	var binaryKSN = hexstringToData( ksn ); // binary

	return ANDdata( mask, binaryKSN ); // return binary ksn
}

// Input: hex strings.
// bdk should be the hex-string representation of a 16-byte key.
// ksn should be the hex-string representation of a 10-byte KSN.
function createIPEK( bdk, ksn ) {

	var CBC = 1;  		     // cipher block chaining enabled
	var iv = "\0\0\0\0\0\0\0\0"; // initial vector

	var key = EDE3KeyExpand( bdk ); // make 24-byte key
	key = hexstringToData( key ); // make it binary

	var maskedKSN = ANDdata( 
			hexstringToData( "FFFFFFFFFFFFFFE00000" ),
			hexstringToData( ksn )
		); // this is now binary

	maskedKSN = maskedKSN.substring(0,8); // take 1st 8 bytes only

	// get LEFT half of IPEK
	var cipher = des( key,
			  maskedKSN,
			  true, /* encrypt */
			  CBC,
			  iv,
			  null );

	var IPEK = dataToHexstring( cipher );

	// get RIGHT half of IPEK
	var mask = "C0C0C0C000000000C0C0C0C000000000";
	key  = XORdata( hexstringToData( mask ), hexstringToData( bdk ) ); 
	key = EDE3KeyExpand( key );
	cipher =     des( key,
			  maskedKSN,
			  true, /* encrypt */
			  CBC,
			  iv,
			  null );

	// join the new cipher to the end of the IPEK:
	IPEK += dataToHexstring( cipher );

	return IPEK;
}

// Expects binary input, not hex string:
function getCounter( ksn ) {
	
	var tailbytes = ksn.substring( ksn.length - 3);
	var integerValue = (tailbytes.charCodeAt(0) << 16) + 
			(tailbytes.charCodeAt(1) << 8) + 
			tailbytes.charCodeAt(2);
	return integerValue & 0x1FFFFF;
}



// Expects binary input, not hex string:
function deriveKey(ipek, ksn) {

  console.log("============================================");
  console.log("In deriveKey()...");
  console.log("ipek: " + dataToHexstring(ipek) );
  if ( ksn.length == 10 )
    ksn = ksn.substring(2); // we want the bottom 8 bytes

  var baseKSN = ANDdata( hexstringToData("FFFFFFFFFFE00000"), ksn );
  console.log("baseKSN: " + dataToHexstring( baseKSN ) );
  var curKey = ipek;
  var counter = getCounter( ksn ); 
  var pass = 0;
  var shifts = 0;
  
  for (var shiftReg = 0x100000; shiftReg > 0; shiftReg >>= 1, shifts++)
  {
    if ( ( shiftReg & counter ) > 0) 
    {
      // Need to do baseKSN |= shiftReg
      var tmpKSN = baseKSN.substring(0,5);
      var byte5 =  baseKSN.charCodeAt(5);
      var byte6 =  baseKSN.charCodeAt(6);
      var byte7 =  baseKSN.charCodeAt(7);
      var tmpLong = (byte5 << 16) + (byte6 << 8) + byte7;
      tmpLong |= shiftReg;
      tmpKSN  += String.fromCharCode( tmpLong >> 16 );
      tmpKSN  += String.fromCharCode( 255 & ( tmpLong >> 8 ) );
      tmpKSN  += String.fromCharCode( 255 & tmpLong );

      baseKSN = tmpKSN; // remember the updated value
      
      console.log("++++++++++++++++++++++++++++++++++++++++++++");
      console.log("tmpKSN: " + dataToHexstring( baseKSN ) );
      
      console.log("curKey :" + dataToHexstring( curKey ) );
      console.log("tmpKey :" + dataToHexstring( tmpKSN ) );
      
      curKey = generateKey( curKey, tmpKSN );  
      pass ++;
      console.log("Pass  : " + pass + "\tbaseKSN: " + dataToHexstring(baseKSN))
      console.log("curKey: " + dataToHexstring(curKey) );	
    }
  }
  console.log("shifts: " + shifts);
  console.log("============================================");
  
  return curKey; // binary
}

// Input is a 16-byte key and 8-byte root KSN;
// output is 16-byte key, encrypted
function generateKey(key, ksn) {

    var mask = "C0C0C0C000000000C0C0C0C000000000";
    var maskedKey = XORdata( hexstringToData( mask ) , key );
    console.log("masked KEY: " + dataToHexstring( maskedKey ) );

    var left = encryptRegister( maskedKey, ksn );
    console.log("llreg: " + dataToHexstring( left ) );
    var right = encryptRegister( key, ksn );
    console.log("rreg: " + dataToHexstring( right ) );

    return left + right; // binary

}

// Returns an 8-byte result
function encryptRegister(key, reg) {

	var CBC = 1;  		     // cipher block chaining enabled
	var iv = "\0\0\0\0\0\0\0\0"; // initial vector

 	var bottom8 = key.substring( key.length-8 ); // bottom 8 bytes

	var top8 = key.substring(0,8); // top 8 bytes
  console.log("top-8 :" + dataToHexstring( top8 ) );

	var bottom8xorKSN = XORdata( bottom8, reg );
  console.log("bottom XOR :" + dataToHexstring( bottom8xorKSN ) );

	// This will be single-DES because of the 8-byte key:
	var desEncrypted = des( top8, 
			    bottom8xorKSN, 
			    true, /* encrypt */
			    CBC,
			    iv,
			    null );

  console.log("REG DES: " + dataToHexstring( desEncrypted ) );
  
	var result = XORdata( bottom8, desEncrypted );
	
	return result; // return the 8-byte result

}



// createDataKeyHex()
//
// Takes a hex (ASCII) ipek and a hex (ASCII) ksn.
// Returns a hex (ASCII) session key.
function createDataKeyHex(ipek, ksn) {

    var derivedPEK = deriveKeyHex( ipek, ksn );  // derive PEK
    console.log( "derived key: " + derivedPEK );

    var CBC = 1;  		 // cipher block chaining enabled
    var iv = "\0\0\0\0\0\0\0\0"; // initial vector
    var variantMask = "0000000000FF00000000000000FF0000"; // data variant                     
	
    var maskedPEK = XORdataHex( variantMask, derivedPEK ); // apply mask

    maskedPEK = hexstringToData( maskedPEK ); // use binary data from here on
    
    console.log("maskedPEK Reduced : " + dataToHexstring( maskedPEK.substring(0,8) ) );
    console.log("maskedPEK Expanded: " + dataToHexstring( EDE3KeyExpand( maskedPEK ) ) );

    // We need to TDES-encrypt the masked key in two parts, using
    // itself as the key. This is a so-called one-way function (OWF).
    // The leftmost 8 bytes are encrypted, then
    // the rightmost 8 bytes are encrypted separately. In each case,
    // the key is the entire original 16-byte maskedPEK from the
    // above step, expanded to 24 bytes per EDE3.

    // left half:
    var left = des(  EDE3KeyExpand( maskedPEK ),
			    maskedPEK.substring(0,8), 
			    true,
			    CBC,
			    iv,
			    null );     
    console.log("left: " + dataToHexstring( left ) );

    // right half:
    var right = des( EDE3KeyExpand( maskedPEK ),
			    maskedPEK.substring(8), 
			    true,
			    CBC,
			    iv,
			    null );     
    console.log("right: " + dataToHexstring( right ) );

    var sessionKey = left + right;

    sessionKey = dataToHexstring( sessionKey ); 
    console.log("sessionKey: " + sessionKey);
    
    return sessionKey; // hex
}


function deriveKeyHex( ipek, ksn ) {

    var binipek = hexstringToData( ipek );
    var binksn = hexstringToData( ksn );

    var dk = deriveKey(binipek, binksn);
    return dataToHexstring( dk );
}

// =============================== WEB API ====================================
/* 

The web API allows this page to be invoked with a URL that contains a 
query string of the type

ksn=01234567801020304050&data=0abcdef01234560abcdef0123456 (etc.)

all of which is appended to the primary URL using a question mark as delimiter:

http://url.to.the.tool?ksn=012340123401234&data=4567845678456780abcd

Allowed parameters include:

ksn	20-nibble hex string
data	hex string
bdk	hex string of BDK (optional; ANSI test key is default)
keymode	"datakey", "mackey", or "pinkey" (optional; datakey is default)
enc	"AES" or "TDES" (optional: TDES is default)

DO NOT use spaces or escape characters in URL. Alphanumeric ASCII only.

*/

function parseURL( ) {

	var url = window.location. href;  // get our own URL

	if ( !url.match( /[#?]/ ) )
		return null;   // nothing to do

	var query = url.split(/[#?]/)[1];  // get query portion

	var dataItems = query.split( /&/ );

	var params = {};

	function getParams( item ) {
		if ( item.indexOf("=") != -1 ) {
			var pieces = item.split("=");
			params[ pieces[0].toLowerCase() ] = pieces[1];
		}
	}
	
	dataItems.forEach( getParams );
	return params;
}

function executeURLQuery( ) {

	var params = parseURL( );

	if ( !params ) return null;  // nothing to do

	var ksn, data, bdk, keymode, encryption_mode;

	if ( "ksn" in params )
		ksn = params[ "ksn" ];
	else 
		return null;

	if ( "data" in params ) 
		data = params[ "data" ];
	else
		return null;
	
	bdk = ("bdk" in params)? params[ "bdk" ] : $('#dBDK').val();
	keymode = ( "keymode" in params )? params[ "keymode" ] : "datakey";
	encryption_mode = ( "enc" in params )? params[ "enc" ].toUpperCase() : "TDES";

	decrypt( ksn, data, bdk, keymode, encryption_mode );
}

// decrypt( )
//
// Call this routine to programmatically decrypt
// data via a known KSN while also automatically updating
// form fields, in the app, to the associated 
// data, key, and output values.
// NOTE: All args should be hex STRINGS
// Call this function with 3rd arg of $('#dBDK').val()
// 4th arg: "datakey" (or "pinkey" or "mackey")
// final arg: encryption_mode = "TDES" or "AES"

function decrypt( ksn, data, bdk, keymode, encryption_mode ) {

	document.querySelector("#encryptionMode").checked = 
		encryption_mode == "AES" ? true : false;  // set checkbox

	$('#data').val( data );  // set data in data field

	var ipek = createIPEK( bdk, ksn ); // Always start with IPEK

	var sk;

	if ( keymode == "datakey" )
		sk = createDataKeyHex( ipek, ksn );
	if ( keymode == "pinkey" )
		sk = createPINKeyHex( ipek, ksn );
	if ( keymode == "mackey" )
		sk = createMACKeyHex( ipek, ksn );

   	document.querySelector("#key").value = sk; // put key in Key text field 

	doEncryption( false );  // decrypt

	// generate tooltip from decrypted value
	var node = document.querySelector("#output");
	setTooltip( node, hexToText( node.value) );
}




// =============================== DES CRYPTO =================================
//DES implementation based on code by:
//Paul Tero, July 2001
//http://www.tero.co.uk/des/
//
//Optimised for performance with large blocks by Michael Hayworth, November 2001
//http://www.netdealing.com


// All inputs are binary.
// If key length is more than 8 bytes, TDES will occur. Otherwise single-DES.
// encrypt -- true, or false (false decrypts)
// mode -- set to 1 for CBC
// iv -- initial vector
// padding -- can be null

function des (key, message, encrypt, mode, iv, padding ) {
  //declaring this locally speeds things up a bit
  var spfunction1 = new Array (0x1010400,0,0x10000,0x1010404,0x1010004,0x10404,0x4,0x10000,0x400,0x1010400,0x1010404,0x400,0x1000404,0x1010004,0x1000000,0x4,0x404,0x1000400,0x1000400,0x10400,0x10400,0x1010000,0x1010000,0x1000404,0x10004,0x1000004,0x1000004,0x10004,0,0x404,0x10404,0x1000000,0x10000,0x1010404,0x4,0x1010000,0x1010400,0x1000000,0x1000000,0x400,0x1010004,0x10000,0x10400,0x1000004,0x400,0x4,0x1000404,0x10404,0x1010404,0x10004,0x1010000,0x1000404,0x1000004,0x404,0x10404,0x1010400,0x404,0x1000400,0x1000400,0,0x10004,0x10400,0,0x1010004);
  var spfunction2 = new Array (-0x7fef7fe0,-0x7fff8000,0x8000,0x108020,0x100000,0x20,-0x7fefffe0,-0x7fff7fe0,-0x7fffffe0,-0x7fef7fe0,-0x7fef8000,-0x80000000,-0x7fff8000,0x100000,0x20,-0x7fefffe0,0x108000,0x100020,-0x7fff7fe0,0,-0x80000000,0x8000,0x108020,-0x7ff00000,0x100020,-0x7fffffe0,0,0x108000,0x8020,-0x7fef8000,-0x7ff00000,0x8020,0,0x108020,-0x7fefffe0,0x100000,-0x7fff7fe0,-0x7ff00000,-0x7fef8000,0x8000,-0x7ff00000,-0x7fff8000,0x20,-0x7fef7fe0,0x108020,0x20,0x8000,-0x80000000,0x8020,-0x7fef8000,0x100000,-0x7fffffe0,0x100020,-0x7fff7fe0,-0x7fffffe0,0x100020,0x108000,0,-0x7fff8000,0x8020,-0x80000000,-0x7fefffe0,-0x7fef7fe0,0x108000);
  var spfunction3 = new Array (0x208,0x8020200,0,0x8020008,0x8000200,0,0x20208,0x8000200,0x20008,0x8000008,0x8000008,0x20000,0x8020208,0x20008,0x8020000,0x208,0x8000000,0x8,0x8020200,0x200,0x20200,0x8020000,0x8020008,0x20208,0x8000208,0x20200,0x20000,0x8000208,0x8,0x8020208,0x200,0x8000000,0x8020200,0x8000000,0x20008,0x208,0x20000,0x8020200,0x8000200,0,0x200,0x20008,0x8020208,0x8000200,0x8000008,0x200,0,0x8020008,0x8000208,0x20000,0x8000000,0x8020208,0x8,0x20208,0x20200,0x8000008,0x8020000,0x8000208,0x208,0x8020000,0x20208,0x8,0x8020008,0x20200);
  var spfunction4 = new Array (0x802001,0x2081,0x2081,0x80,0x802080,0x800081,0x800001,0x2001,0,0x802000,0x802000,0x802081,0x81,0,0x800080,0x800001,0x1,0x2000,0x800000,0x802001,0x80,0x800000,0x2001,0x2080,0x800081,0x1,0x2080,0x800080,0x2000,0x802080,0x802081,0x81,0x800080,0x800001,0x802000,0x802081,0x81,0,0,0x802000,0x2080,0x800080,0x800081,0x1,0x802001,0x2081,0x2081,0x80,0x802081,0x81,0x1,0x2000,0x800001,0x2001,0x802080,0x800081,0x2001,0x2080,0x800000,0x802001,0x80,0x800000,0x2000,0x802080);
  var spfunction5 = new Array (0x100,0x2080100,0x2080000,0x42000100,0x80000,0x100,0x40000000,0x2080000,0x40080100,0x80000,0x2000100,0x40080100,0x42000100,0x42080000,0x80100,0x40000000,0x2000000,0x40080000,0x40080000,0,0x40000100,0x42080100,0x42080100,0x2000100,0x42080000,0x40000100,0,0x42000000,0x2080100,0x2000000,0x42000000,0x80100,0x80000,0x42000100,0x100,0x2000000,0x40000000,0x2080000,0x42000100,0x40080100,0x2000100,0x40000000,0x42080000,0x2080100,0x40080100,0x100,0x2000000,0x42080000,0x42080100,0x80100,0x42000000,0x42080100,0x2080000,0,0x40080000,0x42000000,0x80100,0x2000100,0x40000100,0x80000,0,0x40080000,0x2080100,0x40000100);
  var spfunction6 = new Array (0x20000010,0x20400000,0x4000,0x20404010,0x20400000,0x10,0x20404010,0x400000,0x20004000,0x404010,0x400000,0x20000010,0x400010,0x20004000,0x20000000,0x4010,0,0x400010,0x20004010,0x4000,0x404000,0x20004010,0x10,0x20400010,0x20400010,0,0x404010,0x20404000,0x4010,0x404000,0x20404000,0x20000000,0x20004000,0x10,0x20400010,0x404000,0x20404010,0x400000,0x4010,0x20000010,0x400000,0x20004000,0x20000000,0x4010,0x20000010,0x20404010,0x404000,0x20400000,0x404010,0x20404000,0,0x20400010,0x10,0x4000,0x20400000,0x404010,0x4000,0x400010,0x20004010,0,0x20404000,0x20000000,0x400010,0x20004010);
  var spfunction7 = new Array (0x200000,0x4200002,0x4000802,0,0x800,0x4000802,0x200802,0x4200800,0x4200802,0x200000,0,0x4000002,0x2,0x4000000,0x4200002,0x802,0x4000800,0x200802,0x200002,0x4000800,0x4000002,0x4200000,0x4200800,0x200002,0x4200000,0x800,0x802,0x4200802,0x200800,0x2,0x4000000,0x200800,0x4000000,0x200800,0x200000,0x4000802,0x4000802,0x4200002,0x4200002,0x2,0x200002,0x4000000,0x4000800,0x200000,0x4200800,0x802,0x200802,0x4200800,0x802,0x4000002,0x4200802,0x4200000,0x200800,0,0x2,0x4200802,0,0x200802,0x4200000,0x800,0x4000002,0x4000800,0x800,0x200002);
  var spfunction8 = new Array (0x10001040,0x1000,0x40000,0x10041040,0x10000000,0x10001040,0x40,0x10000000,0x40040,0x10040000,0x10041040,0x41000,0x10041000,0x41040,0x1000,0x40,0x10040000,0x10000040,0x10001000,0x1040,0x41000,0x40040,0x10040040,0x10041000,0x1040,0,0,0x10040040,0x10000040,0x10001000,0x41040,0x40000,0x41040,0x40000,0x10041000,0x1000,0x40,0x10040040,0x1000,0x41040,0x10001000,0x40,0x10000040,0x10040000,0x10040040,0x10000000,0x40000,0x10001040,0,0x10041040,0x40040,0x10000040,0x10040000,0x10001000,0x10001040,0,0x10041040,0x41000,0x41000,0x1040,0x1040,0x40040,0x10000000,0x10041000);

  //create the subkeys we will need
  var keys = des_createKeys (key); 
  var m=0, i, j, temp, temp2, right1, right2, left, right, looping;
  var cbcleft, cbcleft2, cbcright, cbcright2
  var endloop, loopinc;
  var len = message.length;
  var chunk = 0;
  //set up the loops for single and triple des
  var iterations = keys.length == 32 ? 3 : 9; //single or triple des
  if (iterations == 3) {looping = encrypt ? new Array (0, 32, 2) : new Array (30, -2, -2);}
  else {looping = encrypt ? new Array (0, 32, 2, 62, 30, -2, 64, 96, 2) : new Array (94, 62, -2, 32, 64, 2, 30, -2, -2);}

  //pad the message depending on the padding parameter
  if (padding == 2) message += "        "; //pad the message with spaces
  if (padding == 1) {
    temp = 8-(len%8); 
    message += String.fromCharCode (temp,temp,temp,temp,temp,temp,temp,temp); 
    if (temp==8) 
      len+=8;
  } //PKCS7 padding
  if (!padding) message += "\0\0\0\0\0\0\0\0"; //pad the message out with null bytes

  //store the result here
  result = "";
  tempresult = "";

  if (mode == 1) { //CBC mode
    cbcleft = (iv.charCodeAt(m++) << 24) | (iv.charCodeAt(m++) << 16) | (iv.charCodeAt(m++) << 8) | iv.charCodeAt(m++);
    cbcright = (iv.charCodeAt(m++) << 24) | (iv.charCodeAt(m++) << 16) | (iv.charCodeAt(m++) << 8) | iv.charCodeAt(m++);
    m=0;
  }

  //loop through each 64 bit chunk of the message
  while (m < len) {
    left = (message.charCodeAt(m++) << 24) | (message.charCodeAt(m++) << 16) | (message.charCodeAt(m++) << 8) | message.charCodeAt(m++);
    right = (message.charCodeAt(m++) << 24) | (message.charCodeAt(m++) << 16) | (message.charCodeAt(m++) << 8) | message.charCodeAt(m++);

    //for Cipher Block Chaining mode, xor the message with the previous result
    if (mode == 1) {if (encrypt) {left ^= cbcleft; right ^= cbcright;} else {cbcleft2 = cbcleft; cbcright2 = cbcright; cbcleft = left; cbcright = right;}}

    //first each 64 but chunk of the message must be permuted according to IP
    temp = ((left >>> 4) ^ right) & 0x0f0f0f0f; right ^= temp; left ^= (temp << 4);
    temp = ((left >>> 16) ^ right) & 0x0000ffff; right ^= temp; left ^= (temp << 16);
    temp = ((right >>> 2) ^ left) & 0x33333333; left ^= temp; right ^= (temp << 2);
    temp = ((right >>> 8) ^ left) & 0x00ff00ff; left ^= temp; right ^= (temp << 8);
    temp = ((left >>> 1) ^ right) & 0x55555555; right ^= temp; left ^= (temp << 1);

    left = ((left << 1) | (left >>> 31)); 
    right = ((right << 1) | (right >>> 31)); 

    //do this either 1 or 3 times for each chunk of the message
    for (j=0; j<iterations; j+=3) {
      endloop = looping[j+1];
      loopinc = looping[j+2];
      //now go through and perform the encryption or decryption  
      for (i=looping[j]; i!=endloop; i+=loopinc) { //for efficiency
        right1 = right ^ keys[i]; 
        right2 = ((right >>> 4) | (right << 28)) ^ keys[i+1];
        //the result is attained by passing these bytes through the S selection functions
        temp = left;
        left = right;
        right = temp ^ (spfunction2[(right1 >>> 24) & 0x3f] | spfunction4[(right1 >>> 16) & 0x3f]
              | spfunction6[(right1 >>>  8) & 0x3f] | spfunction8[right1 & 0x3f]
              | spfunction1[(right2 >>> 24) & 0x3f] | spfunction3[(right2 >>> 16) & 0x3f]
              | spfunction5[(right2 >>>  8) & 0x3f] | spfunction7[right2 & 0x3f]);
      }
      temp = left; left = right; right = temp; //unreverse left and right
    } //for either 1 or 3 iterations

    //move then each one bit to the right
    left = ((left >>> 1) | (left << 31)); 
    right = ((right >>> 1) | (right << 31)); 

    //now perform IP-1, which is IP in the opposite direction
    temp = ((left >>> 1) ^ right) & 0x55555555; right ^= temp; left ^= (temp << 1);
    temp = ((right >>> 8) ^ left) & 0x00ff00ff; left ^= temp; right ^= (temp << 8);
    temp = ((right >>> 2) ^ left) & 0x33333333; left ^= temp; right ^= (temp << 2);
    temp = ((left >>> 16) ^ right) & 0x0000ffff; right ^= temp; left ^= (temp << 16);
    temp = ((left >>> 4) ^ right) & 0x0f0f0f0f; right ^= temp; left ^= (temp << 4);

    //for Cipher Block Chaining mode, xor the message with the previous result
    if (mode == 1) {
      if (encrypt) {
        cbcleft = left; cbcright = right;
      }
      else {
        left ^= cbcleft2; right ^= cbcright2;
      }
    }
    
    tempresult += String.fromCharCode ((left>>>24), ((left>>>16) & 0xff), ((left>>>8) & 0xff), (left & 0xff), (right>>>24), ((right>>>16) & 0xff), ((right>>>8) & 0xff), (right & 0xff));

    chunk += 8;
    
    if (chunk == 512) {
      result += tempresult; 
      tempresult = ""; 
      chunk = 0;
    }
  } //for every 8 characters, or 64 bits in the message

  result += tempresult;
  /* result = result.replace(/\0*$/g, ""); */

  return result;
} //end of des



// des_createKeys
// Input 8-byte key for single-DES. A key of length > 8 results in TDES automatically.
// Returns 16 48-bit keys.
function des_createKeys (key) {
  pc2bytes0  = new Array (0,0x4,0x20000000,0x20000004,0x10000,0x10004,0x20010000,0x20010004,0x200,0x204,0x20000200,0x20000204,0x10200,0x10204,0x20010200,0x20010204);
  pc2bytes1  = new Array (0,0x1,0x100000,0x100001,0x4000000,0x4000001,0x4100000,0x4100001,0x100,0x101,0x100100,0x100101,0x4000100,0x4000101,0x4100100,0x4100101);
  pc2bytes2  = new Array (0,0x8,0x800,0x808,0x1000000,0x1000008,0x1000800,0x1000808,0,0x8,0x800,0x808,0x1000000,0x1000008,0x1000800,0x1000808);
  pc2bytes3  = new Array (0,0x200000,0x8000000,0x8200000,0x2000,0x202000,0x8002000,0x8202000,0x20000,0x220000,0x8020000,0x8220000,0x22000,0x222000,0x8022000,0x8222000);
  pc2bytes4  = new Array (0,0x40000,0x10,0x40010,0,0x40000,0x10,0x40010,0x1000,0x41000,0x1010,0x41010,0x1000,0x41000,0x1010,0x41010);
  pc2bytes5  = new Array (0,0x400,0x20,0x420,0,0x400,0x20,0x420,0x2000000,0x2000400,0x2000020,0x2000420,0x2000000,0x2000400,0x2000020,0x2000420);
  pc2bytes6  = new Array (0,0x10000000,0x80000,0x10080000,0x2,0x10000002,0x80002,0x10080002,0,0x10000000,0x80000,0x10080000,0x2,0x10000002,0x80002,0x10080002);
  pc2bytes7  = new Array (0,0x10000,0x800,0x10800,0x20000000,0x20010000,0x20000800,0x20010800,0x20000,0x30000,0x20800,0x30800,0x20020000,0x20030000,0x20020800,0x20030800);
  pc2bytes8  = new Array (0,0x40000,0,0x40000,0x2,0x40002,0x2,0x40002,0x2000000,0x2040000,0x2000000,0x2040000,0x2000002,0x2040002,0x2000002,0x2040002);
  pc2bytes9  = new Array (0,0x10000000,0x8,0x10000008,0,0x10000000,0x8,0x10000008,0x400,0x10000400,0x408,0x10000408,0x400,0x10000400,0x408,0x10000408);
  pc2bytes10 = new Array (0,0x20,0,0x20,0x100000,0x100020,0x100000,0x100020,0x2000,0x2020,0x2000,0x2020,0x102000,0x102020,0x102000,0x102020);
  pc2bytes11 = new Array (0,0x1000000,0x200,0x1000200,0x200000,0x1200000,0x200200,0x1200200,0x4000000,0x5000000,0x4000200,0x5000200,0x4200000,0x5200000,0x4200200,0x5200200);
  pc2bytes12 = new Array (0,0x1000,0x8000000,0x8001000,0x80000,0x81000,0x8080000,0x8081000,0x10,0x1010,0x8000010,0x8001010,0x80010,0x81010,0x8080010,0x8081010);
  pc2bytes13 = new Array (0,0x4,0x100,0x104,0,0x4,0x100,0x104,0x1,0x5,0x101,0x105,0x1,0x5,0x101,0x105);

  //how many iterations (1 for des, 3 for triple des)
  var iterations = key.length > 8 ? 3 : 1; // use Triple DES for 9+ byte keys
  //stores the return keys
  var keys = new Array (32 * iterations);
  //now define the left shifts which need to be done
  var shifts = new Array (0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0);
  //other variables
  var lefttemp, righttemp, m=0, n=0, temp;

  for (var j=0; j<iterations; j++) { //either 1 or 3 iterations
    left = (key.charCodeAt(m++) << 24) | (key.charCodeAt(m++) << 16) | (key.charCodeAt(m++) << 8) | key.charCodeAt(m++);
    right = (key.charCodeAt(m++) << 24) | (key.charCodeAt(m++) << 16) | (key.charCodeAt(m++) << 8) | key.charCodeAt(m++);

    temp = ((left >>> 4) ^ right) & 0x0f0f0f0f; right ^= temp; left ^= (temp << 4);
    temp = ((right >>> -16) ^ left) & 0x0000ffff; left ^= temp; right ^= (temp << -16);
    temp = ((left >>> 2) ^ right) & 0x33333333; right ^= temp; left ^= (temp << 2);
    temp = ((right >>> -16) ^ left) & 0x0000ffff; left ^= temp; right ^= (temp << -16);
    temp = ((left >>> 1) ^ right) & 0x55555555; right ^= temp; left ^= (temp << 1);
    temp = ((right >>> 8) ^ left) & 0x00ff00ff; left ^= temp; right ^= (temp << 8);
    temp = ((left >>> 1) ^ right) & 0x55555555; right ^= temp; left ^= (temp << 1);

    //the right side needs to be shifted and to get the last four bits of the left side
    temp = (left << 8) | ((right >>> 20) & 0x000000f0);
    //left needs to be put upside down
    left = (right << 24) | ((right << 8) & 0xff0000) | ((right >>> 8) & 0xff00) | ((right >>> 24) & 0xf0);
    right = temp;

    //now go through and perform these shifts on the left and right keys
    for (i=0; i < shifts.length; i++) {
      //shift the keys either one or two bits to the left
      if (shifts[i]) {left = (left << 2) | (left >>> 26); right = (right << 2) | (right >>> 26);}
      else {left = (left << 1) | (left >>> 27); right = (right << 1) | (right >>> 27);}
      left &= -0xf; right &= -0xf;

      //Now apply PC-2, in such a way that E is easier when encrypting or decrypting.
      //This conversion will look like PC-2 except only the last 6 bits of each byte are used
      //rather than 48 consecutive bits and the order of lines will be according to 
      //how the S selection functions will be applied: S2, S4, S6, S8, S1, S3, S5, S7
      lefttemp = pc2bytes0[left >>> 28] | pc2bytes1[(left >>> 24) & 0xf]
              | pc2bytes2[(left >>> 20) & 0xf] | pc2bytes3[(left >>> 16) & 0xf]
              | pc2bytes4[(left >>> 12) & 0xf] | pc2bytes5[(left >>> 8) & 0xf]
              | pc2bytes6[(left >>> 4) & 0xf];
      righttemp = pc2bytes7[right >>> 28] | pc2bytes8[(right >>> 24) & 0xf]
                | pc2bytes9[(right >>> 20) & 0xf] | pc2bytes10[(right >>> 16) & 0xf]
                | pc2bytes11[(right >>> 12) & 0xf] | pc2bytes12[(right >>> 8) & 0xf]
                | pc2bytes13[(right >>> 4) & 0xf];
      temp = ((righttemp >>> 16) ^ lefttemp) & 0x0000ffff; 
      keys[n++] = lefttemp ^ temp; keys[n++] = righttemp ^ (temp << 16);
    }
  } //for each iterations
  //return the keys we've created
  return keys;
} //end of des_createKeys

// =========== END OF TDES ============






// ===========  BEGIN AES =============

/*

The MIT License (MIT)

Copyright (c) 2015 Richard Moore

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.

See https://github.com/ricmoo/aes-js for more info.

*/



(function(root) {

    var createBuffer = null, copyBuffer = null, convertBytesToString, convertStringToBytes = null;

    var slowCreateBuffer = function(arg) {

        // Passed in a single number, the length to pre-allocate
        if (typeof arg === 'number') {
            var result = [];
            for (var i = 0; i < arg; i++) {
                result.push(0);
            }
            return result;

        } else  {
            // Make sure they are passing sensible data
            for (var i = 0; i < arg.length; i++) {
                if (arg[i] < 0 || arg[i] >= 256 || typeof arg[i] !== 'number') {
                    throw new Error('invalid byte (' + arg[i] + ':' + i + ')');
                }
            }

            // Most array-like things should support this
            if (arg.slice) {
                return arg.slice(0);
            }

            // Something *weird*; copy it into an array (see PR#2)
            var result = [];
            for (var i = 0; i < arg.length; i++) {
                result.push(arg[i]);
            }
            return result;
        }
    }

    if (typeof(Buffer) === 'undefined') {
        createBuffer = slowCreateBuffer;

        copyBuffer = function(sourceBuffer, targetBuffer, targetStart, sourceStart, sourceEnd) {
            if (targetStart == null) { targetStart = 0; }
            if (sourceStart == null) { sourceStart = 0; }
            if (sourceEnd == null) { sourceEnd = sourceBuffer.length; }
            for (var i = sourceStart; i < sourceEnd; i++) {
                targetBuffer[targetStart++] = sourceBuffer[i];
            }
        }

        convertStringToBytes = function(text, encoding) {

            // "utf8", "utf-8", "utf 8", etc
            if (encoding == null || encoding.toLowerCase().replace(/ |-/g, "") == 'utf8') {
                var result = [], i = 0;
                text = encodeURI(text);
                while (i < text.length) {
                    var c = text.charCodeAt(i++);

                    // if it is a % sign, encode the following 2 bytes as a hex value
                    if (c === 37) {
                        result.push(parseInt(text.substr(i, 2), 16))
                        i += 2;

                    // otherwise, just the actual byte
                    } else {
                        result.push(c)
                    }
                }

                return result;

            // "hex"
            } else if (encoding.toLowerCase() == 'hex') {
                var result = [];
                for (var i = 0; i < text.length; i += 2) {
                    result.push(parseInt(text.substr(i, 2), 16));
                }

                return result;
            }

            // @TODO: Base64...

            return null;
        }

        // http://ixti.net/development/javascript/2011/11/11/base64-encodedecode-of-utf8-in-browser-with-js.html
        var Hex = '0123456789abcdef';
        convertBytesToString = function(bytes, encoding) {

            // "utf8", "utf-8", "utf 8", etc
            if (encoding == null || encoding.toLowerCase().replace(/ |-/g, "") == 'utf8') {
                var result = [], i = 0;

                while (i < bytes.length) {
                    var c = bytes[i];

                    if (c < 128) {
                        result.push(String.fromCharCode(c));
                        i++;
                    } else if (c > 191 && c < 224) {
                        result.push(String.fromCharCode(((c & 0x1f) << 6) | (bytes[i + 1] & 0x3f)));
                        i += 2;
                    } else {
                        result.push(String.fromCharCode(((c & 0x0f) << 12) | ((bytes[i + 1] & 0x3f) << 6) | (bytes[i + 2] & 0x3f)));
                        i += 3;
                    }
                }

                return result.join('');

            // "hex"
            } else if (encoding.toLowerCase() == 'hex') {
                var result = [];
                for (var i = 0; i < bytes.length; i++) {
                    var v = bytes[i];
                    result.push(Hex[(v & 0xf0) >> 4] + Hex[v & 0x0f]);
                }
                return result.join('');
            }

            return result
        }

    } else {
        createBuffer = function(arg) { return new Buffer(arg); }

        copyBuffer = function(sourceBuffer, targetBuffer, targetStart, sourceStart, sourceEnd) {
            sourceBuffer.copy(targetBuffer, targetStart, sourceStart, sourceEnd);
        }

        convertStringToBytes = function(text, encoding) {
            return new Buffer(text, encoding);
        }

        convertBytesToString = function(bytes, encoding) {
            return (new Buffer(bytes)).toString(encoding);
        }
    }


    // Number of rounds by keysize
    var numberOfRounds = {16: 10, 24: 12, 32: 14}

    // Round constant words
    var rcon = [0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x1b, 0x36, 0x6c, 0xd8, 0xab, 0x4d, 0x9a, 0x2f, 0x5e, 0xbc, 0x63, 0xc6, 0x97, 0x35, 0x6a, 0xd4, 0xb3, 0x7d, 0xfa, 0xef, 0xc5, 0x91];

    // S-box and Inverse S-box (S is for Substitution)
    var S = [0x63, 0x7c, 0x77, 0x7b, 0xf2, 0x6b, 0x6f, 0xc5, 0x30, 0x01, 0x67, 0x2b, 0xfe, 0xd7, 0xab, 0x76, 0xca, 0x82, 0xc9, 0x7d, 0xfa, 0x59, 0x47, 0xf0, 0xad, 0xd4, 0xa2, 0xaf, 0x9c, 0xa4, 0x72, 0xc0, 0xb7, 0xfd, 0x93, 0x26, 0x36, 0x3f, 0xf7, 0xcc, 0x34, 0xa5, 0xe5, 0xf1, 0x71, 0xd8, 0x31, 0x15, 0x04, 0xc7, 0x23, 0xc3, 0x18, 0x96, 0x05, 0x9a, 0x07, 0x12, 0x80, 0xe2, 0xeb, 0x27, 0xb2, 0x75, 0x09, 0x83, 0x2c, 0x1a, 0x1b, 0x6e, 0x5a, 0xa0, 0x52, 0x3b, 0xd6, 0xb3, 0x29, 0xe3, 0x2f, 0x84, 0x53, 0xd1, 0x00, 0xed, 0x20, 0xfc, 0xb1, 0x5b, 0x6a, 0xcb, 0xbe, 0x39, 0x4a, 0x4c, 0x58, 0xcf, 0xd0, 0xef, 0xaa, 0xfb, 0x43, 0x4d, 0x33, 0x85, 0x45, 0xf9, 0x02, 0x7f, 0x50, 0x3c, 0x9f, 0xa8, 0x51, 0xa3, 0x40, 0x8f, 0x92, 0x9d, 0x38, 0xf5, 0xbc, 0xb6, 0xda, 0x21, 0x10, 0xff, 0xf3, 0xd2, 0xcd, 0x0c, 0x13, 0xec, 0x5f, 0x97, 0x44, 0x17, 0xc4, 0xa7, 0x7e, 0x3d, 0x64, 0x5d, 0x19, 0x73, 0x60, 0x81, 0x4f, 0xdc, 0x22, 0x2a, 0x90, 0x88, 0x46, 0xee, 0xb8, 0x14, 0xde, 0x5e, 0x0b, 0xdb, 0xe0, 0x32, 0x3a, 0x0a, 0x49, 0x06, 0x24, 0x5c, 0xc2, 0xd3, 0xac, 0x62, 0x91, 0x95, 0xe4, 0x79, 0xe7, 0xc8, 0x37, 0x6d, 0x8d, 0xd5, 0x4e, 0xa9, 0x6c, 0x56, 0xf4, 0xea, 0x65, 0x7a, 0xae, 0x08, 0xba, 0x78, 0x25, 0x2e, 0x1c, 0xa6, 0xb4, 0xc6, 0xe8, 0xdd, 0x74, 0x1f, 0x4b, 0xbd, 0x8b, 0x8a, 0x70, 0x3e, 0xb5, 0x66, 0x48, 0x03, 0xf6, 0x0e, 0x61, 0x35, 0x57, 0xb9, 0x86, 0xc1, 0x1d, 0x9e, 0xe1, 0xf8, 0x98, 0x11, 0x69, 0xd9, 0x8e, 0x94, 0x9b, 0x1e, 0x87, 0xe9, 0xce, 0x55, 0x28, 0xdf, 0x8c, 0xa1, 0x89, 0x0d, 0xbf, 0xe6, 0x42, 0x68, 0x41, 0x99, 0x2d, 0x0f, 0xb0, 0x54, 0xbb, 0x16];
    var Si =[0x52, 0x09, 0x6a, 0xd5, 0x30, 0x36, 0xa5, 0x38, 0xbf, 0x40, 0xa3, 0x9e, 0x81, 0xf3, 0xd7, 0xfb, 0x7c, 0xe3, 0x39, 0x82, 0x9b, 0x2f, 0xff, 0x87, 0x34, 0x8e, 0x43, 0x44, 0xc4, 0xde, 0xe9, 0xcb, 0x54, 0x7b, 0x94, 0x32, 0xa6, 0xc2, 0x23, 0x3d, 0xee, 0x4c, 0x95, 0x0b, 0x42, 0xfa, 0xc3, 0x4e, 0x08, 0x2e, 0xa1, 0x66, 0x28, 0xd9, 0x24, 0xb2, 0x76, 0x5b, 0xa2, 0x49, 0x6d, 0x8b, 0xd1, 0x25, 0x72, 0xf8, 0xf6, 0x64, 0x86, 0x68, 0x98, 0x16, 0xd4, 0xa4, 0x5c, 0xcc, 0x5d, 0x65, 0xb6, 0x92, 0x6c, 0x70, 0x48, 0x50, 0xfd, 0xed, 0xb9, 0xda, 0x5e, 0x15, 0x46, 0x57, 0xa7, 0x8d, 0x9d, 0x84, 0x90, 0xd8, 0xab, 0x00, 0x8c, 0xbc, 0xd3, 0x0a, 0xf7, 0xe4, 0x58, 0x05, 0xb8, 0xb3, 0x45, 0x06, 0xd0, 0x2c, 0x1e, 0x8f, 0xca, 0x3f, 0x0f, 0x02, 0xc1, 0xaf, 0xbd, 0x03, 0x01, 0x13, 0x8a, 0x6b, 0x3a, 0x91, 0x11, 0x41, 0x4f, 0x67, 0xdc, 0xea, 0x97, 0xf2, 0xcf, 0xce, 0xf0, 0xb4, 0xe6, 0x73, 0x96, 0xac, 0x74, 0x22, 0xe7, 0xad, 0x35, 0x85, 0xe2, 0xf9, 0x37, 0xe8, 0x1c, 0x75, 0xdf, 0x6e, 0x47, 0xf1, 0x1a, 0x71, 0x1d, 0x29, 0xc5, 0x89, 0x6f, 0xb7, 0x62, 0x0e, 0xaa, 0x18, 0xbe, 0x1b, 0xfc, 0x56, 0x3e, 0x4b, 0xc6, 0xd2, 0x79, 0x20, 0x9a, 0xdb, 0xc0, 0xfe, 0x78, 0xcd, 0x5a, 0xf4, 0x1f, 0xdd, 0xa8, 0x33, 0x88, 0x07, 0xc7, 0x31, 0xb1, 0x12, 0x10, 0x59, 0x27, 0x80, 0xec, 0x5f, 0x60, 0x51, 0x7f, 0xa9, 0x19, 0xb5, 0x4a, 0x0d, 0x2d, 0xe5, 0x7a, 0x9f, 0x93, 0xc9, 0x9c, 0xef, 0xa0, 0xe0, 0x3b, 0x4d, 0xae, 0x2a, 0xf5, 0xb0, 0xc8, 0xeb, 0xbb, 0x3c, 0x83, 0x53, 0x99, 0x61, 0x17, 0x2b, 0x04, 0x7e, 0xba, 0x77, 0xd6, 0x26, 0xe1, 0x69, 0x14, 0x63, 0x55, 0x21, 0x0c, 0x7d];

    // Transformations for encryption
    var T1 = [0xc66363a5, 0xf87c7c84, 0xee777799, 0xf67b7b8d, 0xfff2f20d, 0xd66b6bbd, 0xde6f6fb1, 0x91c5c554, 0x60303050, 0x02010103, 0xce6767a9, 0x562b2b7d, 0xe7fefe19, 0xb5d7d762, 0x4dababe6, 0xec76769a, 0x8fcaca45, 0x1f82829d, 0x89c9c940, 0xfa7d7d87, 0xeffafa15, 0xb25959eb, 0x8e4747c9, 0xfbf0f00b, 0x41adadec, 0xb3d4d467, 0x5fa2a2fd, 0x45afafea, 0x239c9cbf, 0x53a4a4f7, 0xe4727296, 0x9bc0c05b, 0x75b7b7c2, 0xe1fdfd1c, 0x3d9393ae, 0x4c26266a, 0x6c36365a, 0x7e3f3f41, 0xf5f7f702, 0x83cccc4f, 0x6834345c, 0x51a5a5f4, 0xd1e5e534, 0xf9f1f108, 0xe2717193, 0xabd8d873, 0x62313153, 0x2a15153f, 0x0804040c, 0x95c7c752, 0x46232365, 0x9dc3c35e, 0x30181828, 0x379696a1, 0x0a05050f, 0x2f9a9ab5, 0x0e070709, 0x24121236, 0x1b80809b, 0xdfe2e23d, 0xcdebeb26, 0x4e272769, 0x7fb2b2cd, 0xea75759f, 0x1209091b, 0x1d83839e, 0x582c2c74, 0x341a1a2e, 0x361b1b2d, 0xdc6e6eb2, 0xb45a5aee, 0x5ba0a0fb, 0xa45252f6, 0x763b3b4d, 0xb7d6d661, 0x7db3b3ce, 0x5229297b, 0xdde3e33e, 0x5e2f2f71, 0x13848497, 0xa65353f5, 0xb9d1d168, 0x00000000, 0xc1eded2c, 0x40202060, 0xe3fcfc1f, 0x79b1b1c8, 0xb65b5bed, 0xd46a6abe, 0x8dcbcb46, 0x67bebed9, 0x7239394b, 0x944a4ade, 0x984c4cd4, 0xb05858e8, 0x85cfcf4a, 0xbbd0d06b, 0xc5efef2a, 0x4faaaae5, 0xedfbfb16, 0x864343c5, 0x9a4d4dd7, 0x66333355, 0x11858594, 0x8a4545cf, 0xe9f9f910, 0x04020206, 0xfe7f7f81, 0xa05050f0, 0x783c3c44, 0x259f9fba, 0x4ba8a8e3, 0xa25151f3, 0x5da3a3fe, 0x804040c0, 0x058f8f8a, 0x3f9292ad, 0x219d9dbc, 0x70383848, 0xf1f5f504, 0x63bcbcdf, 0x77b6b6c1, 0xafdada75, 0x42212163, 0x20101030, 0xe5ffff1a, 0xfdf3f30e, 0xbfd2d26d, 0x81cdcd4c, 0x180c0c14, 0x26131335, 0xc3ecec2f, 0xbe5f5fe1, 0x359797a2, 0x884444cc, 0x2e171739, 0x93c4c457, 0x55a7a7f2, 0xfc7e7e82, 0x7a3d3d47, 0xc86464ac, 0xba5d5de7, 0x3219192b, 0xe6737395, 0xc06060a0, 0x19818198, 0x9e4f4fd1, 0xa3dcdc7f, 0x44222266, 0x542a2a7e, 0x3b9090ab, 0x0b888883, 0x8c4646ca, 0xc7eeee29, 0x6bb8b8d3, 0x2814143c, 0xa7dede79, 0xbc5e5ee2, 0x160b0b1d, 0xaddbdb76, 0xdbe0e03b, 0x64323256, 0x743a3a4e, 0x140a0a1e, 0x924949db, 0x0c06060a, 0x4824246c, 0xb85c5ce4, 0x9fc2c25d, 0xbdd3d36e, 0x43acacef, 0xc46262a6, 0x399191a8, 0x319595a4, 0xd3e4e437, 0xf279798b, 0xd5e7e732, 0x8bc8c843, 0x6e373759, 0xda6d6db7, 0x018d8d8c, 0xb1d5d564, 0x9c4e4ed2, 0x49a9a9e0, 0xd86c6cb4, 0xac5656fa, 0xf3f4f407, 0xcfeaea25, 0xca6565af, 0xf47a7a8e, 0x47aeaee9, 0x10080818, 0x6fbabad5, 0xf0787888, 0x4a25256f, 0x5c2e2e72, 0x381c1c24, 0x57a6a6f1, 0x73b4b4c7, 0x97c6c651, 0xcbe8e823, 0xa1dddd7c, 0xe874749c, 0x3e1f1f21, 0x964b4bdd, 0x61bdbddc, 0x0d8b8b86, 0x0f8a8a85, 0xe0707090, 0x7c3e3e42, 0x71b5b5c4, 0xcc6666aa, 0x904848d8, 0x06030305, 0xf7f6f601, 0x1c0e0e12, 0xc26161a3, 0x6a35355f, 0xae5757f9, 0x69b9b9d0, 0x17868691, 0x99c1c158, 0x3a1d1d27, 0x279e9eb9, 0xd9e1e138, 0xebf8f813, 0x2b9898b3, 0x22111133, 0xd26969bb, 0xa9d9d970, 0x078e8e89, 0x339494a7, 0x2d9b9bb6, 0x3c1e1e22, 0x15878792, 0xc9e9e920, 0x87cece49, 0xaa5555ff, 0x50282878, 0xa5dfdf7a, 0x038c8c8f, 0x59a1a1f8, 0x09898980, 0x1a0d0d17, 0x65bfbfda, 0xd7e6e631, 0x844242c6, 0xd06868b8, 0x824141c3, 0x299999b0, 0x5a2d2d77, 0x1e0f0f11, 0x7bb0b0cb, 0xa85454fc, 0x6dbbbbd6, 0x2c16163a];
    var T2 = [0xa5c66363, 0x84f87c7c, 0x99ee7777, 0x8df67b7b, 0x0dfff2f2, 0xbdd66b6b, 0xb1de6f6f, 0x5491c5c5, 0x50603030, 0x03020101, 0xa9ce6767, 0x7d562b2b, 0x19e7fefe, 0x62b5d7d7, 0xe64dabab, 0x9aec7676, 0x458fcaca, 0x9d1f8282, 0x4089c9c9, 0x87fa7d7d, 0x15effafa, 0xebb25959, 0xc98e4747, 0x0bfbf0f0, 0xec41adad, 0x67b3d4d4, 0xfd5fa2a2, 0xea45afaf, 0xbf239c9c, 0xf753a4a4, 0x96e47272, 0x5b9bc0c0, 0xc275b7b7, 0x1ce1fdfd, 0xae3d9393, 0x6a4c2626, 0x5a6c3636, 0x417e3f3f, 0x02f5f7f7, 0x4f83cccc, 0x5c683434, 0xf451a5a5, 0x34d1e5e5, 0x08f9f1f1, 0x93e27171, 0x73abd8d8, 0x53623131, 0x3f2a1515, 0x0c080404, 0x5295c7c7, 0x65462323, 0x5e9dc3c3, 0x28301818, 0xa1379696, 0x0f0a0505, 0xb52f9a9a, 0x090e0707, 0x36241212, 0x9b1b8080, 0x3ddfe2e2, 0x26cdebeb, 0x694e2727, 0xcd7fb2b2, 0x9fea7575, 0x1b120909, 0x9e1d8383, 0x74582c2c, 0x2e341a1a, 0x2d361b1b, 0xb2dc6e6e, 0xeeb45a5a, 0xfb5ba0a0, 0xf6a45252, 0x4d763b3b, 0x61b7d6d6, 0xce7db3b3, 0x7b522929, 0x3edde3e3, 0x715e2f2f, 0x97138484, 0xf5a65353, 0x68b9d1d1, 0x00000000, 0x2cc1eded, 0x60402020, 0x1fe3fcfc, 0xc879b1b1, 0xedb65b5b, 0xbed46a6a, 0x468dcbcb, 0xd967bebe, 0x4b723939, 0xde944a4a, 0xd4984c4c, 0xe8b05858, 0x4a85cfcf, 0x6bbbd0d0, 0x2ac5efef, 0xe54faaaa, 0x16edfbfb, 0xc5864343, 0xd79a4d4d, 0x55663333, 0x94118585, 0xcf8a4545, 0x10e9f9f9, 0x06040202, 0x81fe7f7f, 0xf0a05050, 0x44783c3c, 0xba259f9f, 0xe34ba8a8, 0xf3a25151, 0xfe5da3a3, 0xc0804040, 0x8a058f8f, 0xad3f9292, 0xbc219d9d, 0x48703838, 0x04f1f5f5, 0xdf63bcbc, 0xc177b6b6, 0x75afdada, 0x63422121, 0x30201010, 0x1ae5ffff, 0x0efdf3f3, 0x6dbfd2d2, 0x4c81cdcd, 0x14180c0c, 0x35261313, 0x2fc3ecec, 0xe1be5f5f, 0xa2359797, 0xcc884444, 0x392e1717, 0x5793c4c4, 0xf255a7a7, 0x82fc7e7e, 0x477a3d3d, 0xacc86464, 0xe7ba5d5d, 0x2b321919, 0x95e67373, 0xa0c06060, 0x98198181, 0xd19e4f4f, 0x7fa3dcdc, 0x66442222, 0x7e542a2a, 0xab3b9090, 0x830b8888, 0xca8c4646, 0x29c7eeee, 0xd36bb8b8, 0x3c281414, 0x79a7dede, 0xe2bc5e5e, 0x1d160b0b, 0x76addbdb, 0x3bdbe0e0, 0x56643232, 0x4e743a3a, 0x1e140a0a, 0xdb924949, 0x0a0c0606, 0x6c482424, 0xe4b85c5c, 0x5d9fc2c2, 0x6ebdd3d3, 0xef43acac, 0xa6c46262, 0xa8399191, 0xa4319595, 0x37d3e4e4, 0x8bf27979, 0x32d5e7e7, 0x438bc8c8, 0x596e3737, 0xb7da6d6d, 0x8c018d8d, 0x64b1d5d5, 0xd29c4e4e, 0xe049a9a9, 0xb4d86c6c, 0xfaac5656, 0x07f3f4f4, 0x25cfeaea, 0xafca6565, 0x8ef47a7a, 0xe947aeae, 0x18100808, 0xd56fbaba, 0x88f07878, 0x6f4a2525, 0x725c2e2e, 0x24381c1c, 0xf157a6a6, 0xc773b4b4, 0x5197c6c6, 0x23cbe8e8, 0x7ca1dddd, 0x9ce87474, 0x213e1f1f, 0xdd964b4b, 0xdc61bdbd, 0x860d8b8b, 0x850f8a8a, 0x90e07070, 0x427c3e3e, 0xc471b5b5, 0xaacc6666, 0xd8904848, 0x05060303, 0x01f7f6f6, 0x121c0e0e, 0xa3c26161, 0x5f6a3535, 0xf9ae5757, 0xd069b9b9, 0x91178686, 0x5899c1c1, 0x273a1d1d, 0xb9279e9e, 0x38d9e1e1, 0x13ebf8f8, 0xb32b9898, 0x33221111, 0xbbd26969, 0x70a9d9d9, 0x89078e8e, 0xa7339494, 0xb62d9b9b, 0x223c1e1e, 0x92158787, 0x20c9e9e9, 0x4987cece, 0xffaa5555, 0x78502828, 0x7aa5dfdf, 0x8f038c8c, 0xf859a1a1, 0x80098989, 0x171a0d0d, 0xda65bfbf, 0x31d7e6e6, 0xc6844242, 0xb8d06868, 0xc3824141, 0xb0299999, 0x775a2d2d, 0x111e0f0f, 0xcb7bb0b0, 0xfca85454, 0xd66dbbbb, 0x3a2c1616];
    var T3 = [0x63a5c663, 0x7c84f87c, 0x7799ee77, 0x7b8df67b, 0xf20dfff2, 0x6bbdd66b, 0x6fb1de6f, 0xc55491c5, 0x30506030, 0x01030201, 0x67a9ce67, 0x2b7d562b, 0xfe19e7fe, 0xd762b5d7, 0xabe64dab, 0x769aec76, 0xca458fca, 0x829d1f82, 0xc94089c9, 0x7d87fa7d, 0xfa15effa, 0x59ebb259, 0x47c98e47, 0xf00bfbf0, 0xadec41ad, 0xd467b3d4, 0xa2fd5fa2, 0xafea45af, 0x9cbf239c, 0xa4f753a4, 0x7296e472, 0xc05b9bc0, 0xb7c275b7, 0xfd1ce1fd, 0x93ae3d93, 0x266a4c26, 0x365a6c36, 0x3f417e3f, 0xf702f5f7, 0xcc4f83cc, 0x345c6834, 0xa5f451a5, 0xe534d1e5, 0xf108f9f1, 0x7193e271, 0xd873abd8, 0x31536231, 0x153f2a15, 0x040c0804, 0xc75295c7, 0x23654623, 0xc35e9dc3, 0x18283018, 0x96a13796, 0x050f0a05, 0x9ab52f9a, 0x07090e07, 0x12362412, 0x809b1b80, 0xe23ddfe2, 0xeb26cdeb, 0x27694e27, 0xb2cd7fb2, 0x759fea75, 0x091b1209, 0x839e1d83, 0x2c74582c, 0x1a2e341a, 0x1b2d361b, 0x6eb2dc6e, 0x5aeeb45a, 0xa0fb5ba0, 0x52f6a452, 0x3b4d763b, 0xd661b7d6, 0xb3ce7db3, 0x297b5229, 0xe33edde3, 0x2f715e2f, 0x84971384, 0x53f5a653, 0xd168b9d1, 0x00000000, 0xed2cc1ed, 0x20604020, 0xfc1fe3fc, 0xb1c879b1, 0x5bedb65b, 0x6abed46a, 0xcb468dcb, 0xbed967be, 0x394b7239, 0x4ade944a, 0x4cd4984c, 0x58e8b058, 0xcf4a85cf, 0xd06bbbd0, 0xef2ac5ef, 0xaae54faa, 0xfb16edfb, 0x43c58643, 0x4dd79a4d, 0x33556633, 0x85941185, 0x45cf8a45, 0xf910e9f9, 0x02060402, 0x7f81fe7f, 0x50f0a050, 0x3c44783c, 0x9fba259f, 0xa8e34ba8, 0x51f3a251, 0xa3fe5da3, 0x40c08040, 0x8f8a058f, 0x92ad3f92, 0x9dbc219d, 0x38487038, 0xf504f1f5, 0xbcdf63bc, 0xb6c177b6, 0xda75afda, 0x21634221, 0x10302010, 0xff1ae5ff, 0xf30efdf3, 0xd26dbfd2, 0xcd4c81cd, 0x0c14180c, 0x13352613, 0xec2fc3ec, 0x5fe1be5f, 0x97a23597, 0x44cc8844, 0x17392e17, 0xc45793c4, 0xa7f255a7, 0x7e82fc7e, 0x3d477a3d, 0x64acc864, 0x5de7ba5d, 0x192b3219, 0x7395e673, 0x60a0c060, 0x81981981, 0x4fd19e4f, 0xdc7fa3dc, 0x22664422, 0x2a7e542a, 0x90ab3b90, 0x88830b88, 0x46ca8c46, 0xee29c7ee, 0xb8d36bb8, 0x143c2814, 0xde79a7de, 0x5ee2bc5e, 0x0b1d160b, 0xdb76addb, 0xe03bdbe0, 0x32566432, 0x3a4e743a, 0x0a1e140a, 0x49db9249, 0x060a0c06, 0x246c4824, 0x5ce4b85c, 0xc25d9fc2, 0xd36ebdd3, 0xacef43ac, 0x62a6c462, 0x91a83991, 0x95a43195, 0xe437d3e4, 0x798bf279, 0xe732d5e7, 0xc8438bc8, 0x37596e37, 0x6db7da6d, 0x8d8c018d, 0xd564b1d5, 0x4ed29c4e, 0xa9e049a9, 0x6cb4d86c, 0x56faac56, 0xf407f3f4, 0xea25cfea, 0x65afca65, 0x7a8ef47a, 0xaee947ae, 0x08181008, 0xbad56fba, 0x7888f078, 0x256f4a25, 0x2e725c2e, 0x1c24381c, 0xa6f157a6, 0xb4c773b4, 0xc65197c6, 0xe823cbe8, 0xdd7ca1dd, 0x749ce874, 0x1f213e1f, 0x4bdd964b, 0xbddc61bd, 0x8b860d8b, 0x8a850f8a, 0x7090e070, 0x3e427c3e, 0xb5c471b5, 0x66aacc66, 0x48d89048, 0x03050603, 0xf601f7f6, 0x0e121c0e, 0x61a3c261, 0x355f6a35, 0x57f9ae57, 0xb9d069b9, 0x86911786, 0xc15899c1, 0x1d273a1d, 0x9eb9279e, 0xe138d9e1, 0xf813ebf8, 0x98b32b98, 0x11332211, 0x69bbd269, 0xd970a9d9, 0x8e89078e, 0x94a73394, 0x9bb62d9b, 0x1e223c1e, 0x87921587, 0xe920c9e9, 0xce4987ce, 0x55ffaa55, 0x28785028, 0xdf7aa5df, 0x8c8f038c, 0xa1f859a1, 0x89800989, 0x0d171a0d, 0xbfda65bf, 0xe631d7e6, 0x42c68442, 0x68b8d068, 0x41c38241, 0x99b02999, 0x2d775a2d, 0x0f111e0f, 0xb0cb7bb0, 0x54fca854, 0xbbd66dbb, 0x163a2c16];
    var T4 = [0x6363a5c6, 0x7c7c84f8, 0x777799ee, 0x7b7b8df6, 0xf2f20dff, 0x6b6bbdd6, 0x6f6fb1de, 0xc5c55491, 0x30305060, 0x01010302, 0x6767a9ce, 0x2b2b7d56, 0xfefe19e7, 0xd7d762b5, 0xababe64d, 0x76769aec, 0xcaca458f, 0x82829d1f, 0xc9c94089, 0x7d7d87fa, 0xfafa15ef, 0x5959ebb2, 0x4747c98e, 0xf0f00bfb, 0xadadec41, 0xd4d467b3, 0xa2a2fd5f, 0xafafea45, 0x9c9cbf23, 0xa4a4f753, 0x727296e4, 0xc0c05b9b, 0xb7b7c275, 0xfdfd1ce1, 0x9393ae3d, 0x26266a4c, 0x36365a6c, 0x3f3f417e, 0xf7f702f5, 0xcccc4f83, 0x34345c68, 0xa5a5f451, 0xe5e534d1, 0xf1f108f9, 0x717193e2, 0xd8d873ab, 0x31315362, 0x15153f2a, 0x04040c08, 0xc7c75295, 0x23236546, 0xc3c35e9d, 0x18182830, 0x9696a137, 0x05050f0a, 0x9a9ab52f, 0x0707090e, 0x12123624, 0x80809b1b, 0xe2e23ddf, 0xebeb26cd, 0x2727694e, 0xb2b2cd7f, 0x75759fea, 0x09091b12, 0x83839e1d, 0x2c2c7458, 0x1a1a2e34, 0x1b1b2d36, 0x6e6eb2dc, 0x5a5aeeb4, 0xa0a0fb5b, 0x5252f6a4, 0x3b3b4d76, 0xd6d661b7, 0xb3b3ce7d, 0x29297b52, 0xe3e33edd, 0x2f2f715e, 0x84849713, 0x5353f5a6, 0xd1d168b9, 0x00000000, 0xeded2cc1, 0x20206040, 0xfcfc1fe3, 0xb1b1c879, 0x5b5bedb6, 0x6a6abed4, 0xcbcb468d, 0xbebed967, 0x39394b72, 0x4a4ade94, 0x4c4cd498, 0x5858e8b0, 0xcfcf4a85, 0xd0d06bbb, 0xefef2ac5, 0xaaaae54f, 0xfbfb16ed, 0x4343c586, 0x4d4dd79a, 0x33335566, 0x85859411, 0x4545cf8a, 0xf9f910e9, 0x02020604, 0x7f7f81fe, 0x5050f0a0, 0x3c3c4478, 0x9f9fba25, 0xa8a8e34b, 0x5151f3a2, 0xa3a3fe5d, 0x4040c080, 0x8f8f8a05, 0x9292ad3f, 0x9d9dbc21, 0x38384870, 0xf5f504f1, 0xbcbcdf63, 0xb6b6c177, 0xdada75af, 0x21216342, 0x10103020, 0xffff1ae5, 0xf3f30efd, 0xd2d26dbf, 0xcdcd4c81, 0x0c0c1418, 0x13133526, 0xecec2fc3, 0x5f5fe1be, 0x9797a235, 0x4444cc88, 0x1717392e, 0xc4c45793, 0xa7a7f255, 0x7e7e82fc, 0x3d3d477a, 0x6464acc8, 0x5d5de7ba, 0x19192b32, 0x737395e6, 0x6060a0c0, 0x81819819, 0x4f4fd19e, 0xdcdc7fa3, 0x22226644, 0x2a2a7e54, 0x9090ab3b, 0x8888830b, 0x4646ca8c, 0xeeee29c7, 0xb8b8d36b, 0x14143c28, 0xdede79a7, 0x5e5ee2bc, 0x0b0b1d16, 0xdbdb76ad, 0xe0e03bdb, 0x32325664, 0x3a3a4e74, 0x0a0a1e14, 0x4949db92, 0x06060a0c, 0x24246c48, 0x5c5ce4b8, 0xc2c25d9f, 0xd3d36ebd, 0xacacef43, 0x6262a6c4, 0x9191a839, 0x9595a431, 0xe4e437d3, 0x79798bf2, 0xe7e732d5, 0xc8c8438b, 0x3737596e, 0x6d6db7da, 0x8d8d8c01, 0xd5d564b1, 0x4e4ed29c, 0xa9a9e049, 0x6c6cb4d8, 0x5656faac, 0xf4f407f3, 0xeaea25cf, 0x6565afca, 0x7a7a8ef4, 0xaeaee947, 0x08081810, 0xbabad56f, 0x787888f0, 0x25256f4a, 0x2e2e725c, 0x1c1c2438, 0xa6a6f157, 0xb4b4c773, 0xc6c65197, 0xe8e823cb, 0xdddd7ca1, 0x74749ce8, 0x1f1f213e, 0x4b4bdd96, 0xbdbddc61, 0x8b8b860d, 0x8a8a850f, 0x707090e0, 0x3e3e427c, 0xb5b5c471, 0x6666aacc, 0x4848d890, 0x03030506, 0xf6f601f7, 0x0e0e121c, 0x6161a3c2, 0x35355f6a, 0x5757f9ae, 0xb9b9d069, 0x86869117, 0xc1c15899, 0x1d1d273a, 0x9e9eb927, 0xe1e138d9, 0xf8f813eb, 0x9898b32b, 0x11113322, 0x6969bbd2, 0xd9d970a9, 0x8e8e8907, 0x9494a733, 0x9b9bb62d, 0x1e1e223c, 0x87879215, 0xe9e920c9, 0xcece4987, 0x5555ffaa, 0x28287850, 0xdfdf7aa5, 0x8c8c8f03, 0xa1a1f859, 0x89898009, 0x0d0d171a, 0xbfbfda65, 0xe6e631d7, 0x4242c684, 0x6868b8d0, 0x4141c382, 0x9999b029, 0x2d2d775a, 0x0f0f111e, 0xb0b0cb7b, 0x5454fca8, 0xbbbbd66d, 0x16163a2c];

    // Transformations for decryption
    var T5 = [0x51f4a750, 0x7e416553, 0x1a17a4c3, 0x3a275e96, 0x3bab6bcb, 0x1f9d45f1, 0xacfa58ab, 0x4be30393, 0x2030fa55, 0xad766df6, 0x88cc7691, 0xf5024c25, 0x4fe5d7fc, 0xc52acbd7, 0x26354480, 0xb562a38f, 0xdeb15a49, 0x25ba1b67, 0x45ea0e98, 0x5dfec0e1, 0xc32f7502, 0x814cf012, 0x8d4697a3, 0x6bd3f9c6, 0x038f5fe7, 0x15929c95, 0xbf6d7aeb, 0x955259da, 0xd4be832d, 0x587421d3, 0x49e06929, 0x8ec9c844, 0x75c2896a, 0xf48e7978, 0x99583e6b, 0x27b971dd, 0xbee14fb6, 0xf088ad17, 0xc920ac66, 0x7dce3ab4, 0x63df4a18, 0xe51a3182, 0x97513360, 0x62537f45, 0xb16477e0, 0xbb6bae84, 0xfe81a01c, 0xf9082b94, 0x70486858, 0x8f45fd19, 0x94de6c87, 0x527bf8b7, 0xab73d323, 0x724b02e2, 0xe31f8f57, 0x6655ab2a, 0xb2eb2807, 0x2fb5c203, 0x86c57b9a, 0xd33708a5, 0x302887f2, 0x23bfa5b2, 0x02036aba, 0xed16825c, 0x8acf1c2b, 0xa779b492, 0xf307f2f0, 0x4e69e2a1, 0x65daf4cd, 0x0605bed5, 0xd134621f, 0xc4a6fe8a, 0x342e539d, 0xa2f355a0, 0x058ae132, 0xa4f6eb75, 0x0b83ec39, 0x4060efaa, 0x5e719f06, 0xbd6e1051, 0x3e218af9, 0x96dd063d, 0xdd3e05ae, 0x4de6bd46, 0x91548db5, 0x71c45d05, 0x0406d46f, 0x605015ff, 0x1998fb24, 0xd6bde997, 0x894043cc, 0x67d99e77, 0xb0e842bd, 0x07898b88, 0xe7195b38, 0x79c8eedb, 0xa17c0a47, 0x7c420fe9, 0xf8841ec9, 0x00000000, 0x09808683, 0x322bed48, 0x1e1170ac, 0x6c5a724e, 0xfd0efffb, 0x0f853856, 0x3daed51e, 0x362d3927, 0x0a0fd964, 0x685ca621, 0x9b5b54d1, 0x24362e3a, 0x0c0a67b1, 0x9357e70f, 0xb4ee96d2, 0x1b9b919e, 0x80c0c54f, 0x61dc20a2, 0x5a774b69, 0x1c121a16, 0xe293ba0a, 0xc0a02ae5, 0x3c22e043, 0x121b171d, 0x0e090d0b, 0xf28bc7ad, 0x2db6a8b9, 0x141ea9c8, 0x57f11985, 0xaf75074c, 0xee99ddbb, 0xa37f60fd, 0xf701269f, 0x5c72f5bc, 0x44663bc5, 0x5bfb7e34, 0x8b432976, 0xcb23c6dc, 0xb6edfc68, 0xb8e4f163, 0xd731dcca, 0x42638510, 0x13972240, 0x84c61120, 0x854a247d, 0xd2bb3df8, 0xaef93211, 0xc729a16d, 0x1d9e2f4b, 0xdcb230f3, 0x0d8652ec, 0x77c1e3d0, 0x2bb3166c, 0xa970b999, 0x119448fa, 0x47e96422, 0xa8fc8cc4, 0xa0f03f1a, 0x567d2cd8, 0x223390ef, 0x87494ec7, 0xd938d1c1, 0x8ccaa2fe, 0x98d40b36, 0xa6f581cf, 0xa57ade28, 0xdab78e26, 0x3fadbfa4, 0x2c3a9de4, 0x5078920d, 0x6a5fcc9b, 0x547e4662, 0xf68d13c2, 0x90d8b8e8, 0x2e39f75e, 0x82c3aff5, 0x9f5d80be, 0x69d0937c, 0x6fd52da9, 0xcf2512b3, 0xc8ac993b, 0x10187da7, 0xe89c636e, 0xdb3bbb7b, 0xcd267809, 0x6e5918f4, 0xec9ab701, 0x834f9aa8, 0xe6956e65, 0xaaffe67e, 0x21bccf08, 0xef15e8e6, 0xbae79bd9, 0x4a6f36ce, 0xea9f09d4, 0x29b07cd6, 0x31a4b2af, 0x2a3f2331, 0xc6a59430, 0x35a266c0, 0x744ebc37, 0xfc82caa6, 0xe090d0b0, 0x33a7d815, 0xf104984a, 0x41ecdaf7, 0x7fcd500e, 0x1791f62f, 0x764dd68d, 0x43efb04d, 0xccaa4d54, 0xe49604df, 0x9ed1b5e3, 0x4c6a881b, 0xc12c1fb8, 0x4665517f, 0x9d5eea04, 0x018c355d, 0xfa877473, 0xfb0b412e, 0xb3671d5a, 0x92dbd252, 0xe9105633, 0x6dd64713, 0x9ad7618c, 0x37a10c7a, 0x59f8148e, 0xeb133c89, 0xcea927ee, 0xb761c935, 0xe11ce5ed, 0x7a47b13c, 0x9cd2df59, 0x55f2733f, 0x1814ce79, 0x73c737bf, 0x53f7cdea, 0x5ffdaa5b, 0xdf3d6f14, 0x7844db86, 0xcaaff381, 0xb968c43e, 0x3824342c, 0xc2a3405f, 0x161dc372, 0xbce2250c, 0x283c498b, 0xff0d9541, 0x39a80171, 0x080cb3de, 0xd8b4e49c, 0x6456c190, 0x7bcb8461, 0xd532b670, 0x486c5c74, 0xd0b85742];
    var T6 = [0x5051f4a7, 0x537e4165, 0xc31a17a4, 0x963a275e, 0xcb3bab6b, 0xf11f9d45, 0xabacfa58, 0x934be303, 0x552030fa, 0xf6ad766d, 0x9188cc76, 0x25f5024c, 0xfc4fe5d7, 0xd7c52acb, 0x80263544, 0x8fb562a3, 0x49deb15a, 0x6725ba1b, 0x9845ea0e, 0xe15dfec0, 0x02c32f75, 0x12814cf0, 0xa38d4697, 0xc66bd3f9, 0xe7038f5f, 0x9515929c, 0xebbf6d7a, 0xda955259, 0x2dd4be83, 0xd3587421, 0x2949e069, 0x448ec9c8, 0x6a75c289, 0x78f48e79, 0x6b99583e, 0xdd27b971, 0xb6bee14f, 0x17f088ad, 0x66c920ac, 0xb47dce3a, 0x1863df4a, 0x82e51a31, 0x60975133, 0x4562537f, 0xe0b16477, 0x84bb6bae, 0x1cfe81a0, 0x94f9082b, 0x58704868, 0x198f45fd, 0x8794de6c, 0xb7527bf8, 0x23ab73d3, 0xe2724b02, 0x57e31f8f, 0x2a6655ab, 0x07b2eb28, 0x032fb5c2, 0x9a86c57b, 0xa5d33708, 0xf2302887, 0xb223bfa5, 0xba02036a, 0x5ced1682, 0x2b8acf1c, 0x92a779b4, 0xf0f307f2, 0xa14e69e2, 0xcd65daf4, 0xd50605be, 0x1fd13462, 0x8ac4a6fe, 0x9d342e53, 0xa0a2f355, 0x32058ae1, 0x75a4f6eb, 0x390b83ec, 0xaa4060ef, 0x065e719f, 0x51bd6e10, 0xf93e218a, 0x3d96dd06, 0xaedd3e05, 0x464de6bd, 0xb591548d, 0x0571c45d, 0x6f0406d4, 0xff605015, 0x241998fb, 0x97d6bde9, 0xcc894043, 0x7767d99e, 0xbdb0e842, 0x8807898b, 0x38e7195b, 0xdb79c8ee, 0x47a17c0a, 0xe97c420f, 0xc9f8841e, 0x00000000, 0x83098086, 0x48322bed, 0xac1e1170, 0x4e6c5a72, 0xfbfd0eff, 0x560f8538, 0x1e3daed5, 0x27362d39, 0x640a0fd9, 0x21685ca6, 0xd19b5b54, 0x3a24362e, 0xb10c0a67, 0x0f9357e7, 0xd2b4ee96, 0x9e1b9b91, 0x4f80c0c5, 0xa261dc20, 0x695a774b, 0x161c121a, 0x0ae293ba, 0xe5c0a02a, 0x433c22e0, 0x1d121b17, 0x0b0e090d, 0xadf28bc7, 0xb92db6a8, 0xc8141ea9, 0x8557f119, 0x4caf7507, 0xbbee99dd, 0xfda37f60, 0x9ff70126, 0xbc5c72f5, 0xc544663b, 0x345bfb7e, 0x768b4329, 0xdccb23c6, 0x68b6edfc, 0x63b8e4f1, 0xcad731dc, 0x10426385, 0x40139722, 0x2084c611, 0x7d854a24, 0xf8d2bb3d, 0x11aef932, 0x6dc729a1, 0x4b1d9e2f, 0xf3dcb230, 0xec0d8652, 0xd077c1e3, 0x6c2bb316, 0x99a970b9, 0xfa119448, 0x2247e964, 0xc4a8fc8c, 0x1aa0f03f, 0xd8567d2c, 0xef223390, 0xc787494e, 0xc1d938d1, 0xfe8ccaa2, 0x3698d40b, 0xcfa6f581, 0x28a57ade, 0x26dab78e, 0xa43fadbf, 0xe42c3a9d, 0x0d507892, 0x9b6a5fcc, 0x62547e46, 0xc2f68d13, 0xe890d8b8, 0x5e2e39f7, 0xf582c3af, 0xbe9f5d80, 0x7c69d093, 0xa96fd52d, 0xb3cf2512, 0x3bc8ac99, 0xa710187d, 0x6ee89c63, 0x7bdb3bbb, 0x09cd2678, 0xf46e5918, 0x01ec9ab7, 0xa8834f9a, 0x65e6956e, 0x7eaaffe6, 0x0821bccf, 0xe6ef15e8, 0xd9bae79b, 0xce4a6f36, 0xd4ea9f09, 0xd629b07c, 0xaf31a4b2, 0x312a3f23, 0x30c6a594, 0xc035a266, 0x37744ebc, 0xa6fc82ca, 0xb0e090d0, 0x1533a7d8, 0x4af10498, 0xf741ecda, 0x0e7fcd50, 0x2f1791f6, 0x8d764dd6, 0x4d43efb0, 0x54ccaa4d, 0xdfe49604, 0xe39ed1b5, 0x1b4c6a88, 0xb8c12c1f, 0x7f466551, 0x049d5eea, 0x5d018c35, 0x73fa8774, 0x2efb0b41, 0x5ab3671d, 0x5292dbd2, 0x33e91056, 0x136dd647, 0x8c9ad761, 0x7a37a10c, 0x8e59f814, 0x89eb133c, 0xeecea927, 0x35b761c9, 0xede11ce5, 0x3c7a47b1, 0x599cd2df, 0x3f55f273, 0x791814ce, 0xbf73c737, 0xea53f7cd, 0x5b5ffdaa, 0x14df3d6f, 0x867844db, 0x81caaff3, 0x3eb968c4, 0x2c382434, 0x5fc2a340, 0x72161dc3, 0x0cbce225, 0x8b283c49, 0x41ff0d95, 0x7139a801, 0xde080cb3, 0x9cd8b4e4, 0x906456c1, 0x617bcb84, 0x70d532b6, 0x74486c5c, 0x42d0b857];
    var T7 = [0xa75051f4, 0x65537e41, 0xa4c31a17, 0x5e963a27, 0x6bcb3bab, 0x45f11f9d, 0x58abacfa, 0x03934be3, 0xfa552030, 0x6df6ad76, 0x769188cc, 0x4c25f502, 0xd7fc4fe5, 0xcbd7c52a, 0x44802635, 0xa38fb562, 0x5a49deb1, 0x1b6725ba, 0x0e9845ea, 0xc0e15dfe, 0x7502c32f, 0xf012814c, 0x97a38d46, 0xf9c66bd3, 0x5fe7038f, 0x9c951592, 0x7aebbf6d, 0x59da9552, 0x832dd4be, 0x21d35874, 0x692949e0, 0xc8448ec9, 0x896a75c2, 0x7978f48e, 0x3e6b9958, 0x71dd27b9, 0x4fb6bee1, 0xad17f088, 0xac66c920, 0x3ab47dce, 0x4a1863df, 0x3182e51a, 0x33609751, 0x7f456253, 0x77e0b164, 0xae84bb6b, 0xa01cfe81, 0x2b94f908, 0x68587048, 0xfd198f45, 0x6c8794de, 0xf8b7527b, 0xd323ab73, 0x02e2724b, 0x8f57e31f, 0xab2a6655, 0x2807b2eb, 0xc2032fb5, 0x7b9a86c5, 0x08a5d337, 0x87f23028, 0xa5b223bf, 0x6aba0203, 0x825ced16, 0x1c2b8acf, 0xb492a779, 0xf2f0f307, 0xe2a14e69, 0xf4cd65da, 0xbed50605, 0x621fd134, 0xfe8ac4a6, 0x539d342e, 0x55a0a2f3, 0xe132058a, 0xeb75a4f6, 0xec390b83, 0xefaa4060, 0x9f065e71, 0x1051bd6e, 0x8af93e21, 0x063d96dd, 0x05aedd3e, 0xbd464de6, 0x8db59154, 0x5d0571c4, 0xd46f0406, 0x15ff6050, 0xfb241998, 0xe997d6bd, 0x43cc8940, 0x9e7767d9, 0x42bdb0e8, 0x8b880789, 0x5b38e719, 0xeedb79c8, 0x0a47a17c, 0x0fe97c42, 0x1ec9f884, 0x00000000, 0x86830980, 0xed48322b, 0x70ac1e11, 0x724e6c5a, 0xfffbfd0e, 0x38560f85, 0xd51e3dae, 0x3927362d, 0xd9640a0f, 0xa621685c, 0x54d19b5b, 0x2e3a2436, 0x67b10c0a, 0xe70f9357, 0x96d2b4ee, 0x919e1b9b, 0xc54f80c0, 0x20a261dc, 0x4b695a77, 0x1a161c12, 0xba0ae293, 0x2ae5c0a0, 0xe0433c22, 0x171d121b, 0x0d0b0e09, 0xc7adf28b, 0xa8b92db6, 0xa9c8141e, 0x198557f1, 0x074caf75, 0xddbbee99, 0x60fda37f, 0x269ff701, 0xf5bc5c72, 0x3bc54466, 0x7e345bfb, 0x29768b43, 0xc6dccb23, 0xfc68b6ed, 0xf163b8e4, 0xdccad731, 0x85104263, 0x22401397, 0x112084c6, 0x247d854a, 0x3df8d2bb, 0x3211aef9, 0xa16dc729, 0x2f4b1d9e, 0x30f3dcb2, 0x52ec0d86, 0xe3d077c1, 0x166c2bb3, 0xb999a970, 0x48fa1194, 0x642247e9, 0x8cc4a8fc, 0x3f1aa0f0, 0x2cd8567d, 0x90ef2233, 0x4ec78749, 0xd1c1d938, 0xa2fe8cca, 0x0b3698d4, 0x81cfa6f5, 0xde28a57a, 0x8e26dab7, 0xbfa43fad, 0x9de42c3a, 0x920d5078, 0xcc9b6a5f, 0x4662547e, 0x13c2f68d, 0xb8e890d8, 0xf75e2e39, 0xaff582c3, 0x80be9f5d, 0x937c69d0, 0x2da96fd5, 0x12b3cf25, 0x993bc8ac, 0x7da71018, 0x636ee89c, 0xbb7bdb3b, 0x7809cd26, 0x18f46e59, 0xb701ec9a, 0x9aa8834f, 0x6e65e695, 0xe67eaaff, 0xcf0821bc, 0xe8e6ef15, 0x9bd9bae7, 0x36ce4a6f, 0x09d4ea9f, 0x7cd629b0, 0xb2af31a4, 0x23312a3f, 0x9430c6a5, 0x66c035a2, 0xbc37744e, 0xcaa6fc82, 0xd0b0e090, 0xd81533a7, 0x984af104, 0xdaf741ec, 0x500e7fcd, 0xf62f1791, 0xd68d764d, 0xb04d43ef, 0x4d54ccaa, 0x04dfe496, 0xb5e39ed1, 0x881b4c6a, 0x1fb8c12c, 0x517f4665, 0xea049d5e, 0x355d018c, 0x7473fa87, 0x412efb0b, 0x1d5ab367, 0xd25292db, 0x5633e910, 0x47136dd6, 0x618c9ad7, 0x0c7a37a1, 0x148e59f8, 0x3c89eb13, 0x27eecea9, 0xc935b761, 0xe5ede11c, 0xb13c7a47, 0xdf599cd2, 0x733f55f2, 0xce791814, 0x37bf73c7, 0xcdea53f7, 0xaa5b5ffd, 0x6f14df3d, 0xdb867844, 0xf381caaf, 0xc43eb968, 0x342c3824, 0x405fc2a3, 0xc372161d, 0x250cbce2, 0x498b283c, 0x9541ff0d, 0x017139a8, 0xb3de080c, 0xe49cd8b4, 0xc1906456, 0x84617bcb, 0xb670d532, 0x5c74486c, 0x5742d0b8];
    var T8 = [0xf4a75051, 0x4165537e, 0x17a4c31a, 0x275e963a, 0xab6bcb3b, 0x9d45f11f, 0xfa58abac, 0xe303934b, 0x30fa5520, 0x766df6ad, 0xcc769188, 0x024c25f5, 0xe5d7fc4f, 0x2acbd7c5, 0x35448026, 0x62a38fb5, 0xb15a49de, 0xba1b6725, 0xea0e9845, 0xfec0e15d, 0x2f7502c3, 0x4cf01281, 0x4697a38d, 0xd3f9c66b, 0x8f5fe703, 0x929c9515, 0x6d7aebbf, 0x5259da95, 0xbe832dd4, 0x7421d358, 0xe0692949, 0xc9c8448e, 0xc2896a75, 0x8e7978f4, 0x583e6b99, 0xb971dd27, 0xe14fb6be, 0x88ad17f0, 0x20ac66c9, 0xce3ab47d, 0xdf4a1863, 0x1a3182e5, 0x51336097, 0x537f4562, 0x6477e0b1, 0x6bae84bb, 0x81a01cfe, 0x082b94f9, 0x48685870, 0x45fd198f, 0xde6c8794, 0x7bf8b752, 0x73d323ab, 0x4b02e272, 0x1f8f57e3, 0x55ab2a66, 0xeb2807b2, 0xb5c2032f, 0xc57b9a86, 0x3708a5d3, 0x2887f230, 0xbfa5b223, 0x036aba02, 0x16825ced, 0xcf1c2b8a, 0x79b492a7, 0x07f2f0f3, 0x69e2a14e, 0xdaf4cd65, 0x05bed506, 0x34621fd1, 0xa6fe8ac4, 0x2e539d34, 0xf355a0a2, 0x8ae13205, 0xf6eb75a4, 0x83ec390b, 0x60efaa40, 0x719f065e, 0x6e1051bd, 0x218af93e, 0xdd063d96, 0x3e05aedd, 0xe6bd464d, 0x548db591, 0xc45d0571, 0x06d46f04, 0x5015ff60, 0x98fb2419, 0xbde997d6, 0x4043cc89, 0xd99e7767, 0xe842bdb0, 0x898b8807, 0x195b38e7, 0xc8eedb79, 0x7c0a47a1, 0x420fe97c, 0x841ec9f8, 0x00000000, 0x80868309, 0x2bed4832, 0x1170ac1e, 0x5a724e6c, 0x0efffbfd, 0x8538560f, 0xaed51e3d, 0x2d392736, 0x0fd9640a, 0x5ca62168, 0x5b54d19b, 0x362e3a24, 0x0a67b10c, 0x57e70f93, 0xee96d2b4, 0x9b919e1b, 0xc0c54f80, 0xdc20a261, 0x774b695a, 0x121a161c, 0x93ba0ae2, 0xa02ae5c0, 0x22e0433c, 0x1b171d12, 0x090d0b0e, 0x8bc7adf2, 0xb6a8b92d, 0x1ea9c814, 0xf1198557, 0x75074caf, 0x99ddbbee, 0x7f60fda3, 0x01269ff7, 0x72f5bc5c, 0x663bc544, 0xfb7e345b, 0x4329768b, 0x23c6dccb, 0xedfc68b6, 0xe4f163b8, 0x31dccad7, 0x63851042, 0x97224013, 0xc6112084, 0x4a247d85, 0xbb3df8d2, 0xf93211ae, 0x29a16dc7, 0x9e2f4b1d, 0xb230f3dc, 0x8652ec0d, 0xc1e3d077, 0xb3166c2b, 0x70b999a9, 0x9448fa11, 0xe9642247, 0xfc8cc4a8, 0xf03f1aa0, 0x7d2cd856, 0x3390ef22, 0x494ec787, 0x38d1c1d9, 0xcaa2fe8c, 0xd40b3698, 0xf581cfa6, 0x7ade28a5, 0xb78e26da, 0xadbfa43f, 0x3a9de42c, 0x78920d50, 0x5fcc9b6a, 0x7e466254, 0x8d13c2f6, 0xd8b8e890, 0x39f75e2e, 0xc3aff582, 0x5d80be9f, 0xd0937c69, 0xd52da96f, 0x2512b3cf, 0xac993bc8, 0x187da710, 0x9c636ee8, 0x3bbb7bdb, 0x267809cd, 0x5918f46e, 0x9ab701ec, 0x4f9aa883, 0x956e65e6, 0xffe67eaa, 0xbccf0821, 0x15e8e6ef, 0xe79bd9ba, 0x6f36ce4a, 0x9f09d4ea, 0xb07cd629, 0xa4b2af31, 0x3f23312a, 0xa59430c6, 0xa266c035, 0x4ebc3774, 0x82caa6fc, 0x90d0b0e0, 0xa7d81533, 0x04984af1, 0xecdaf741, 0xcd500e7f, 0x91f62f17, 0x4dd68d76, 0xefb04d43, 0xaa4d54cc, 0x9604dfe4, 0xd1b5e39e, 0x6a881b4c, 0x2c1fb8c1, 0x65517f46, 0x5eea049d, 0x8c355d01, 0x877473fa, 0x0b412efb, 0x671d5ab3, 0xdbd25292, 0x105633e9, 0xd647136d, 0xd7618c9a, 0xa10c7a37, 0xf8148e59, 0x133c89eb, 0xa927eece, 0x61c935b7, 0x1ce5ede1, 0x47b13c7a, 0xd2df599c, 0xf2733f55, 0x14ce7918, 0xc737bf73, 0xf7cdea53, 0xfdaa5b5f, 0x3d6f14df, 0x44db8678, 0xaff381ca, 0x68c43eb9, 0x24342c38, 0xa3405fc2, 0x1dc37216, 0xe2250cbc, 0x3c498b28, 0x0d9541ff, 0xa8017139, 0x0cb3de08, 0xb4e49cd8, 0x56c19064, 0xcb84617b, 0x32b670d5, 0x6c5c7448, 0xb85742d0];

    // Transformations for decryption key expansion
    var U1 = [0x00000000, 0x0e090d0b, 0x1c121a16, 0x121b171d, 0x3824342c, 0x362d3927, 0x24362e3a, 0x2a3f2331, 0x70486858, 0x7e416553, 0x6c5a724e, 0x62537f45, 0x486c5c74, 0x4665517f, 0x547e4662, 0x5a774b69, 0xe090d0b0, 0xee99ddbb, 0xfc82caa6, 0xf28bc7ad, 0xd8b4e49c, 0xd6bde997, 0xc4a6fe8a, 0xcaaff381, 0x90d8b8e8, 0x9ed1b5e3, 0x8ccaa2fe, 0x82c3aff5, 0xa8fc8cc4, 0xa6f581cf, 0xb4ee96d2, 0xbae79bd9, 0xdb3bbb7b, 0xd532b670, 0xc729a16d, 0xc920ac66, 0xe31f8f57, 0xed16825c, 0xff0d9541, 0xf104984a, 0xab73d323, 0xa57ade28, 0xb761c935, 0xb968c43e, 0x9357e70f, 0x9d5eea04, 0x8f45fd19, 0x814cf012, 0x3bab6bcb, 0x35a266c0, 0x27b971dd, 0x29b07cd6, 0x038f5fe7, 0x0d8652ec, 0x1f9d45f1, 0x119448fa, 0x4be30393, 0x45ea0e98, 0x57f11985, 0x59f8148e, 0x73c737bf, 0x7dce3ab4, 0x6fd52da9, 0x61dc20a2, 0xad766df6, 0xa37f60fd, 0xb16477e0, 0xbf6d7aeb, 0x955259da, 0x9b5b54d1, 0x894043cc, 0x87494ec7, 0xdd3e05ae, 0xd33708a5, 0xc12c1fb8, 0xcf2512b3, 0xe51a3182, 0xeb133c89, 0xf9082b94, 0xf701269f, 0x4de6bd46, 0x43efb04d, 0x51f4a750, 0x5ffdaa5b, 0x75c2896a, 0x7bcb8461, 0x69d0937c, 0x67d99e77, 0x3daed51e, 0x33a7d815, 0x21bccf08, 0x2fb5c203, 0x058ae132, 0x0b83ec39, 0x1998fb24, 0x1791f62f, 0x764dd68d, 0x7844db86, 0x6a5fcc9b, 0x6456c190, 0x4e69e2a1, 0x4060efaa, 0x527bf8b7, 0x5c72f5bc, 0x0605bed5, 0x080cb3de, 0x1a17a4c3, 0x141ea9c8, 0x3e218af9, 0x302887f2, 0x223390ef, 0x2c3a9de4, 0x96dd063d, 0x98d40b36, 0x8acf1c2b, 0x84c61120, 0xaef93211, 0xa0f03f1a, 0xb2eb2807, 0xbce2250c, 0xe6956e65, 0xe89c636e, 0xfa877473, 0xf48e7978, 0xdeb15a49, 0xd0b85742, 0xc2a3405f, 0xccaa4d54, 0x41ecdaf7, 0x4fe5d7fc, 0x5dfec0e1, 0x53f7cdea, 0x79c8eedb, 0x77c1e3d0, 0x65daf4cd, 0x6bd3f9c6, 0x31a4b2af, 0x3fadbfa4, 0x2db6a8b9, 0x23bfa5b2, 0x09808683, 0x07898b88, 0x15929c95, 0x1b9b919e, 0xa17c0a47, 0xaf75074c, 0xbd6e1051, 0xb3671d5a, 0x99583e6b, 0x97513360, 0x854a247d, 0x8b432976, 0xd134621f, 0xdf3d6f14, 0xcd267809, 0xc32f7502, 0xe9105633, 0xe7195b38, 0xf5024c25, 0xfb0b412e, 0x9ad7618c, 0x94de6c87, 0x86c57b9a, 0x88cc7691, 0xa2f355a0, 0xacfa58ab, 0xbee14fb6, 0xb0e842bd, 0xea9f09d4, 0xe49604df, 0xf68d13c2, 0xf8841ec9, 0xd2bb3df8, 0xdcb230f3, 0xcea927ee, 0xc0a02ae5, 0x7a47b13c, 0x744ebc37, 0x6655ab2a, 0x685ca621, 0x42638510, 0x4c6a881b, 0x5e719f06, 0x5078920d, 0x0a0fd964, 0x0406d46f, 0x161dc372, 0x1814ce79, 0x322bed48, 0x3c22e043, 0x2e39f75e, 0x2030fa55, 0xec9ab701, 0xe293ba0a, 0xf088ad17, 0xfe81a01c, 0xd4be832d, 0xdab78e26, 0xc8ac993b, 0xc6a59430, 0x9cd2df59, 0x92dbd252, 0x80c0c54f, 0x8ec9c844, 0xa4f6eb75, 0xaaffe67e, 0xb8e4f163, 0xb6edfc68, 0x0c0a67b1, 0x02036aba, 0x10187da7, 0x1e1170ac, 0x342e539d, 0x3a275e96, 0x283c498b, 0x26354480, 0x7c420fe9, 0x724b02e2, 0x605015ff, 0x6e5918f4, 0x44663bc5, 0x4a6f36ce, 0x587421d3, 0x567d2cd8, 0x37a10c7a, 0x39a80171, 0x2bb3166c, 0x25ba1b67, 0x0f853856, 0x018c355d, 0x13972240, 0x1d9e2f4b, 0x47e96422, 0x49e06929, 0x5bfb7e34, 0x55f2733f, 0x7fcd500e, 0x71c45d05, 0x63df4a18, 0x6dd64713, 0xd731dcca, 0xd938d1c1, 0xcb23c6dc, 0xc52acbd7, 0xef15e8e6, 0xe11ce5ed, 0xf307f2f0, 0xfd0efffb, 0xa779b492, 0xa970b999, 0xbb6bae84, 0xb562a38f, 0x9f5d80be, 0x91548db5, 0x834f9aa8, 0x8d4697a3];
    var U2 = [0x00000000, 0x0b0e090d, 0x161c121a, 0x1d121b17, 0x2c382434, 0x27362d39, 0x3a24362e, 0x312a3f23, 0x58704868, 0x537e4165, 0x4e6c5a72, 0x4562537f, 0x74486c5c, 0x7f466551, 0x62547e46, 0x695a774b, 0xb0e090d0, 0xbbee99dd, 0xa6fc82ca, 0xadf28bc7, 0x9cd8b4e4, 0x97d6bde9, 0x8ac4a6fe, 0x81caaff3, 0xe890d8b8, 0xe39ed1b5, 0xfe8ccaa2, 0xf582c3af, 0xc4a8fc8c, 0xcfa6f581, 0xd2b4ee96, 0xd9bae79b, 0x7bdb3bbb, 0x70d532b6, 0x6dc729a1, 0x66c920ac, 0x57e31f8f, 0x5ced1682, 0x41ff0d95, 0x4af10498, 0x23ab73d3, 0x28a57ade, 0x35b761c9, 0x3eb968c4, 0x0f9357e7, 0x049d5eea, 0x198f45fd, 0x12814cf0, 0xcb3bab6b, 0xc035a266, 0xdd27b971, 0xd629b07c, 0xe7038f5f, 0xec0d8652, 0xf11f9d45, 0xfa119448, 0x934be303, 0x9845ea0e, 0x8557f119, 0x8e59f814, 0xbf73c737, 0xb47dce3a, 0xa96fd52d, 0xa261dc20, 0xf6ad766d, 0xfda37f60, 0xe0b16477, 0xebbf6d7a, 0xda955259, 0xd19b5b54, 0xcc894043, 0xc787494e, 0xaedd3e05, 0xa5d33708, 0xb8c12c1f, 0xb3cf2512, 0x82e51a31, 0x89eb133c, 0x94f9082b, 0x9ff70126, 0x464de6bd, 0x4d43efb0, 0x5051f4a7, 0x5b5ffdaa, 0x6a75c289, 0x617bcb84, 0x7c69d093, 0x7767d99e, 0x1e3daed5, 0x1533a7d8, 0x0821bccf, 0x032fb5c2, 0x32058ae1, 0x390b83ec, 0x241998fb, 0x2f1791f6, 0x8d764dd6, 0x867844db, 0x9b6a5fcc, 0x906456c1, 0xa14e69e2, 0xaa4060ef, 0xb7527bf8, 0xbc5c72f5, 0xd50605be, 0xde080cb3, 0xc31a17a4, 0xc8141ea9, 0xf93e218a, 0xf2302887, 0xef223390, 0xe42c3a9d, 0x3d96dd06, 0x3698d40b, 0x2b8acf1c, 0x2084c611, 0x11aef932, 0x1aa0f03f, 0x07b2eb28, 0x0cbce225, 0x65e6956e, 0x6ee89c63, 0x73fa8774, 0x78f48e79, 0x49deb15a, 0x42d0b857, 0x5fc2a340, 0x54ccaa4d, 0xf741ecda, 0xfc4fe5d7, 0xe15dfec0, 0xea53f7cd, 0xdb79c8ee, 0xd077c1e3, 0xcd65daf4, 0xc66bd3f9, 0xaf31a4b2, 0xa43fadbf, 0xb92db6a8, 0xb223bfa5, 0x83098086, 0x8807898b, 0x9515929c, 0x9e1b9b91, 0x47a17c0a, 0x4caf7507, 0x51bd6e10, 0x5ab3671d, 0x6b99583e, 0x60975133, 0x7d854a24, 0x768b4329, 0x1fd13462, 0x14df3d6f, 0x09cd2678, 0x02c32f75, 0x33e91056, 0x38e7195b, 0x25f5024c, 0x2efb0b41, 0x8c9ad761, 0x8794de6c, 0x9a86c57b, 0x9188cc76, 0xa0a2f355, 0xabacfa58, 0xb6bee14f, 0xbdb0e842, 0xd4ea9f09, 0xdfe49604, 0xc2f68d13, 0xc9f8841e, 0xf8d2bb3d, 0xf3dcb230, 0xeecea927, 0xe5c0a02a, 0x3c7a47b1, 0x37744ebc, 0x2a6655ab, 0x21685ca6, 0x10426385, 0x1b4c6a88, 0x065e719f, 0x0d507892, 0x640a0fd9, 0x6f0406d4, 0x72161dc3, 0x791814ce, 0x48322bed, 0x433c22e0, 0x5e2e39f7, 0x552030fa, 0x01ec9ab7, 0x0ae293ba, 0x17f088ad, 0x1cfe81a0, 0x2dd4be83, 0x26dab78e, 0x3bc8ac99, 0x30c6a594, 0x599cd2df, 0x5292dbd2, 0x4f80c0c5, 0x448ec9c8, 0x75a4f6eb, 0x7eaaffe6, 0x63b8e4f1, 0x68b6edfc, 0xb10c0a67, 0xba02036a, 0xa710187d, 0xac1e1170, 0x9d342e53, 0x963a275e, 0x8b283c49, 0x80263544, 0xe97c420f, 0xe2724b02, 0xff605015, 0xf46e5918, 0xc544663b, 0xce4a6f36, 0xd3587421, 0xd8567d2c, 0x7a37a10c, 0x7139a801, 0x6c2bb316, 0x6725ba1b, 0x560f8538, 0x5d018c35, 0x40139722, 0x4b1d9e2f, 0x2247e964, 0x2949e069, 0x345bfb7e, 0x3f55f273, 0x0e7fcd50, 0x0571c45d, 0x1863df4a, 0x136dd647, 0xcad731dc, 0xc1d938d1, 0xdccb23c6, 0xd7c52acb, 0xe6ef15e8, 0xede11ce5, 0xf0f307f2, 0xfbfd0eff, 0x92a779b4, 0x99a970b9, 0x84bb6bae, 0x8fb562a3, 0xbe9f5d80, 0xb591548d, 0xa8834f9a, 0xa38d4697];
    var U3 = [0x00000000, 0x0d0b0e09, 0x1a161c12, 0x171d121b, 0x342c3824, 0x3927362d, 0x2e3a2436, 0x23312a3f, 0x68587048, 0x65537e41, 0x724e6c5a, 0x7f456253, 0x5c74486c, 0x517f4665, 0x4662547e, 0x4b695a77, 0xd0b0e090, 0xddbbee99, 0xcaa6fc82, 0xc7adf28b, 0xe49cd8b4, 0xe997d6bd, 0xfe8ac4a6, 0xf381caaf, 0xb8e890d8, 0xb5e39ed1, 0xa2fe8cca, 0xaff582c3, 0x8cc4a8fc, 0x81cfa6f5, 0x96d2b4ee, 0x9bd9bae7, 0xbb7bdb3b, 0xb670d532, 0xa16dc729, 0xac66c920, 0x8f57e31f, 0x825ced16, 0x9541ff0d, 0x984af104, 0xd323ab73, 0xde28a57a, 0xc935b761, 0xc43eb968, 0xe70f9357, 0xea049d5e, 0xfd198f45, 0xf012814c, 0x6bcb3bab, 0x66c035a2, 0x71dd27b9, 0x7cd629b0, 0x5fe7038f, 0x52ec0d86, 0x45f11f9d, 0x48fa1194, 0x03934be3, 0x0e9845ea, 0x198557f1, 0x148e59f8, 0x37bf73c7, 0x3ab47dce, 0x2da96fd5, 0x20a261dc, 0x6df6ad76, 0x60fda37f, 0x77e0b164, 0x7aebbf6d, 0x59da9552, 0x54d19b5b, 0x43cc8940, 0x4ec78749, 0x05aedd3e, 0x08a5d337, 0x1fb8c12c, 0x12b3cf25, 0x3182e51a, 0x3c89eb13, 0x2b94f908, 0x269ff701, 0xbd464de6, 0xb04d43ef, 0xa75051f4, 0xaa5b5ffd, 0x896a75c2, 0x84617bcb, 0x937c69d0, 0x9e7767d9, 0xd51e3dae, 0xd81533a7, 0xcf0821bc, 0xc2032fb5, 0xe132058a, 0xec390b83, 0xfb241998, 0xf62f1791, 0xd68d764d, 0xdb867844, 0xcc9b6a5f, 0xc1906456, 0xe2a14e69, 0xefaa4060, 0xf8b7527b, 0xf5bc5c72, 0xbed50605, 0xb3de080c, 0xa4c31a17, 0xa9c8141e, 0x8af93e21, 0x87f23028, 0x90ef2233, 0x9de42c3a, 0x063d96dd, 0x0b3698d4, 0x1c2b8acf, 0x112084c6, 0x3211aef9, 0x3f1aa0f0, 0x2807b2eb, 0x250cbce2, 0x6e65e695, 0x636ee89c, 0x7473fa87, 0x7978f48e, 0x5a49deb1, 0x5742d0b8, 0x405fc2a3, 0x4d54ccaa, 0xdaf741ec, 0xd7fc4fe5, 0xc0e15dfe, 0xcdea53f7, 0xeedb79c8, 0xe3d077c1, 0xf4cd65da, 0xf9c66bd3, 0xb2af31a4, 0xbfa43fad, 0xa8b92db6, 0xa5b223bf, 0x86830980, 0x8b880789, 0x9c951592, 0x919e1b9b, 0x0a47a17c, 0x074caf75, 0x1051bd6e, 0x1d5ab367, 0x3e6b9958, 0x33609751, 0x247d854a, 0x29768b43, 0x621fd134, 0x6f14df3d, 0x7809cd26, 0x7502c32f, 0x5633e910, 0x5b38e719, 0x4c25f502, 0x412efb0b, 0x618c9ad7, 0x6c8794de, 0x7b9a86c5, 0x769188cc, 0x55a0a2f3, 0x58abacfa, 0x4fb6bee1, 0x42bdb0e8, 0x09d4ea9f, 0x04dfe496, 0x13c2f68d, 0x1ec9f884, 0x3df8d2bb, 0x30f3dcb2, 0x27eecea9, 0x2ae5c0a0, 0xb13c7a47, 0xbc37744e, 0xab2a6655, 0xa621685c, 0x85104263, 0x881b4c6a, 0x9f065e71, 0x920d5078, 0xd9640a0f, 0xd46f0406, 0xc372161d, 0xce791814, 0xed48322b, 0xe0433c22, 0xf75e2e39, 0xfa552030, 0xb701ec9a, 0xba0ae293, 0xad17f088, 0xa01cfe81, 0x832dd4be, 0x8e26dab7, 0x993bc8ac, 0x9430c6a5, 0xdf599cd2, 0xd25292db, 0xc54f80c0, 0xc8448ec9, 0xeb75a4f6, 0xe67eaaff, 0xf163b8e4, 0xfc68b6ed, 0x67b10c0a, 0x6aba0203, 0x7da71018, 0x70ac1e11, 0x539d342e, 0x5e963a27, 0x498b283c, 0x44802635, 0x0fe97c42, 0x02e2724b, 0x15ff6050, 0x18f46e59, 0x3bc54466, 0x36ce4a6f, 0x21d35874, 0x2cd8567d, 0x0c7a37a1, 0x017139a8, 0x166c2bb3, 0x1b6725ba, 0x38560f85, 0x355d018c, 0x22401397, 0x2f4b1d9e, 0x642247e9, 0x692949e0, 0x7e345bfb, 0x733f55f2, 0x500e7fcd, 0x5d0571c4, 0x4a1863df, 0x47136dd6, 0xdccad731, 0xd1c1d938, 0xc6dccb23, 0xcbd7c52a, 0xe8e6ef15, 0xe5ede11c, 0xf2f0f307, 0xfffbfd0e, 0xb492a779, 0xb999a970, 0xae84bb6b, 0xa38fb562, 0x80be9f5d, 0x8db59154, 0x9aa8834f, 0x97a38d46];
    var U4 = [0x00000000, 0x090d0b0e, 0x121a161c, 0x1b171d12, 0x24342c38, 0x2d392736, 0x362e3a24, 0x3f23312a, 0x48685870, 0x4165537e, 0x5a724e6c, 0x537f4562, 0x6c5c7448, 0x65517f46, 0x7e466254, 0x774b695a, 0x90d0b0e0, 0x99ddbbee, 0x82caa6fc, 0x8bc7adf2, 0xb4e49cd8, 0xbde997d6, 0xa6fe8ac4, 0xaff381ca, 0xd8b8e890, 0xd1b5e39e, 0xcaa2fe8c, 0xc3aff582, 0xfc8cc4a8, 0xf581cfa6, 0xee96d2b4, 0xe79bd9ba, 0x3bbb7bdb, 0x32b670d5, 0x29a16dc7, 0x20ac66c9, 0x1f8f57e3, 0x16825ced, 0x0d9541ff, 0x04984af1, 0x73d323ab, 0x7ade28a5, 0x61c935b7, 0x68c43eb9, 0x57e70f93, 0x5eea049d, 0x45fd198f, 0x4cf01281, 0xab6bcb3b, 0xa266c035, 0xb971dd27, 0xb07cd629, 0x8f5fe703, 0x8652ec0d, 0x9d45f11f, 0x9448fa11, 0xe303934b, 0xea0e9845, 0xf1198557, 0xf8148e59, 0xc737bf73, 0xce3ab47d, 0xd52da96f, 0xdc20a261, 0x766df6ad, 0x7f60fda3, 0x6477e0b1, 0x6d7aebbf, 0x5259da95, 0x5b54d19b, 0x4043cc89, 0x494ec787, 0x3e05aedd, 0x3708a5d3, 0x2c1fb8c1, 0x2512b3cf, 0x1a3182e5, 0x133c89eb, 0x082b94f9, 0x01269ff7, 0xe6bd464d, 0xefb04d43, 0xf4a75051, 0xfdaa5b5f, 0xc2896a75, 0xcb84617b, 0xd0937c69, 0xd99e7767, 0xaed51e3d, 0xa7d81533, 0xbccf0821, 0xb5c2032f, 0x8ae13205, 0x83ec390b, 0x98fb2419, 0x91f62f17, 0x4dd68d76, 0x44db8678, 0x5fcc9b6a, 0x56c19064, 0x69e2a14e, 0x60efaa40, 0x7bf8b752, 0x72f5bc5c, 0x05bed506, 0x0cb3de08, 0x17a4c31a, 0x1ea9c814, 0x218af93e, 0x2887f230, 0x3390ef22, 0x3a9de42c, 0xdd063d96, 0xd40b3698, 0xcf1c2b8a, 0xc6112084, 0xf93211ae, 0xf03f1aa0, 0xeb2807b2, 0xe2250cbc, 0x956e65e6, 0x9c636ee8, 0x877473fa, 0x8e7978f4, 0xb15a49de, 0xb85742d0, 0xa3405fc2, 0xaa4d54cc, 0xecdaf741, 0xe5d7fc4f, 0xfec0e15d, 0xf7cdea53, 0xc8eedb79, 0xc1e3d077, 0xdaf4cd65, 0xd3f9c66b, 0xa4b2af31, 0xadbfa43f, 0xb6a8b92d, 0xbfa5b223, 0x80868309, 0x898b8807, 0x929c9515, 0x9b919e1b, 0x7c0a47a1, 0x75074caf, 0x6e1051bd, 0x671d5ab3, 0x583e6b99, 0x51336097, 0x4a247d85, 0x4329768b, 0x34621fd1, 0x3d6f14df, 0x267809cd, 0x2f7502c3, 0x105633e9, 0x195b38e7, 0x024c25f5, 0x0b412efb, 0xd7618c9a, 0xde6c8794, 0xc57b9a86, 0xcc769188, 0xf355a0a2, 0xfa58abac, 0xe14fb6be, 0xe842bdb0, 0x9f09d4ea, 0x9604dfe4, 0x8d13c2f6, 0x841ec9f8, 0xbb3df8d2, 0xb230f3dc, 0xa927eece, 0xa02ae5c0, 0x47b13c7a, 0x4ebc3774, 0x55ab2a66, 0x5ca62168, 0x63851042, 0x6a881b4c, 0x719f065e, 0x78920d50, 0x0fd9640a, 0x06d46f04, 0x1dc37216, 0x14ce7918, 0x2bed4832, 0x22e0433c, 0x39f75e2e, 0x30fa5520, 0x9ab701ec, 0x93ba0ae2, 0x88ad17f0, 0x81a01cfe, 0xbe832dd4, 0xb78e26da, 0xac993bc8, 0xa59430c6, 0xd2df599c, 0xdbd25292, 0xc0c54f80, 0xc9c8448e, 0xf6eb75a4, 0xffe67eaa, 0xe4f163b8, 0xedfc68b6, 0x0a67b10c, 0x036aba02, 0x187da710, 0x1170ac1e, 0x2e539d34, 0x275e963a, 0x3c498b28, 0x35448026, 0x420fe97c, 0x4b02e272, 0x5015ff60, 0x5918f46e, 0x663bc544, 0x6f36ce4a, 0x7421d358, 0x7d2cd856, 0xa10c7a37, 0xa8017139, 0xb3166c2b, 0xba1b6725, 0x8538560f, 0x8c355d01, 0x97224013, 0x9e2f4b1d, 0xe9642247, 0xe0692949, 0xfb7e345b, 0xf2733f55, 0xcd500e7f, 0xc45d0571, 0xdf4a1863, 0xd647136d, 0x31dccad7, 0x38d1c1d9, 0x23c6dccb, 0x2acbd7c5, 0x15e8e6ef, 0x1ce5ede1, 0x07f2f0f3, 0x0efffbfd, 0x79b492a7, 0x70b999a9, 0x6bae84bb, 0x62a38fb5, 0x5d80be9f, 0x548db591, 0x4f9aa883, 0x4697a38d];


    function convertToInt32(bytes) {
        var result = [];
        for (var i = 0; i < bytes.length; i += 4) {
            result.push(
                (bytes[i    ] << 24) |
                (bytes[i + 1] << 16) |
                (bytes[i + 2] <<  8) |
                 bytes[i + 3]
            );
        }
        return result;
    }




    var AES = function(key) {
        if (!(this instanceof AES)) {
            throw Error('AES must be instanitated with `new`');
        }

        this.key = createBuffer(key);
        this._prepare();
    }


    AES.prototype._prepare = function() {

        var rounds = numberOfRounds[this.key.length];
        if (rounds == null) {
            throw new Error('invalid key size (must be 16, 24 or 32 bytes)');
        }

        // encryption round keys
        this._Ke = [];

        // decryption round keys
        this._Kd = [];

        for (var i = 0; i <= rounds; i++) {
            this._Ke.push([0, 0, 0, 0]);
            this._Kd.push([0, 0, 0, 0]);
        }

        var roundKeyCount = (rounds + 1) * 4;
        var KC = this.key.length / 4;

        // convert the key into ints
        var tk = convertToInt32(this.key);

        // copy values into round key arrays
        var index;
        for (var i = 0; i < KC; i++) {
            index = i >> 2;
            this._Ke[index][i % 4] = tk[i];
            this._Kd[rounds - index][i % 4] = tk[i];
        }

        // key expansion (fips-197 section 5.2)
        var rconpointer = 0;
        var t = KC, tt;
        while (t < roundKeyCount) {
            tt = tk[KC - 1];
            tk[0] ^= ((S[(tt >> 16) & 0xFF] << 24) ^
                      (S[(tt >>  8) & 0xFF] << 16) ^
                      (S[ tt        & 0xFF] <<  8) ^
                       S[(tt >> 24) & 0xFF]        ^
                      (rcon[rconpointer] << 24));
            rconpointer += 1;

            // key expansion (for non-256 bit)
            if (KC != 8) {
                for (var i = 1; i < KC; i++) {
                    tk[i] ^= tk[i - 1];
                }

            // key expansion for 256-bit keys is "slightly different" (fips-197)
            } else {
                for (var i = 1; i < (KC / 2); i++) {
                    tk[i] ^= tk[i - 1];
                }
                tt = tk[(KC / 2) - 1];

                tk[KC / 2] ^= (S[ tt        & 0xFF]        ^
                              (S[(tt >>  8) & 0xFF] <<  8) ^
                              (S[(tt >> 16) & 0xFF] << 16) ^
                              (S[(tt >> 24) & 0xFF] << 24));

                for (var i = (KC / 2) + 1; i < KC; i++) {
                    tk[i] ^= tk[i - 1];
                }
            }

            // copy values into round key arrays
            var i = 0, r, c;
            while (i < KC && t < roundKeyCount) {
                r = t >> 2;
                c = t % 4;
                this._Ke[r][c] = tk[i];
                this._Kd[rounds - r][c] = tk[i++];
                t++;
            }
        }

        // inverse-cipher-ify the decryption round key (fips-197 section 5.3)
        for (var r = 1; r < rounds; r++) {
            for (var c = 0; c < 4; c++) {
                tt = this._Kd[r][c];
                this._Kd[r][c] = (U1[(tt >> 24) & 0xFF] ^
                                  U2[(tt >> 16) & 0xFF] ^
                                  U3[(tt >>  8) & 0xFF] ^
                                  U4[ tt        & 0xFF]);
            }
        }
    }

    AES.prototype.encrypt = function(plaintext) {
        if (plaintext.length != 16) {
            throw new Error('invalid plaintext size (must be 16 bytes)');
        }

        var rounds = this._Ke.length - 1;
        var a = [0, 0, 0, 0];

        // convert plaintext to (ints ^ key)
        var t = convertToInt32(plaintext);
        for (var i = 0; i < 4; i++) {
            t[i] ^= this._Ke[0][i];
        }

        // apply round transforms
        for (var r = 1; r < rounds; r++) {
            for (var i = 0; i < 4; i++) {
                a[i] = (T1[(t[ i         ] >> 24) & 0xff] ^
                        T2[(t[(i + 1) % 4] >> 16) & 0xff] ^
                        T3[(t[(i + 2) % 4] >>  8) & 0xff] ^
                        T4[ t[(i + 3) % 4]        & 0xff] ^
                        this._Ke[r][i]);
            }
            t = a.slice(0);
        }

        // the last round is special
        var result = createBuffer(16), tt;
        for (var i = 0; i < 4; i++) {
            tt = this._Ke[rounds][i];
            result[4 * i    ] = (S[(t[ i         ] >> 24) & 0xff] ^ (tt >> 24)) & 0xff;
            result[4 * i + 1] = (S[(t[(i + 1) % 4] >> 16) & 0xff] ^ (tt >> 16)) & 0xff;
            result[4 * i + 2] = (S[(t[(i + 2) % 4] >>  8) & 0xff] ^ (tt >>  8)) & 0xff;
            result[4 * i + 3] = (S[ t[(i + 3) % 4]        & 0xff] ^  tt       ) & 0xff;
        }

        return result;
    }

    AES.prototype.decrypt = function(ciphertext) {
        if (ciphertext.length != 16) {
            throw new Error('invalid ciphertext size (must be 16 bytes)');
        }

        var rounds = this._Kd.length - 1;
        var a = [0, 0, 0, 0];

        // convert plaintext to (ints ^ key)
        var t = convertToInt32(ciphertext);
        for (var i = 0; i < 4; i++) {
            t[i] ^= this._Kd[0][i];
        }

        // apply round transforms
        for (var r = 1; r < rounds; r++) {
            for (var i = 0; i < 4; i++) {
                a[i] = (T5[(t[ i          ] >> 24) & 0xff] ^
                        T6[(t[(i + 3) % 4] >> 16) & 0xff] ^
                        T7[(t[(i + 2) % 4] >>  8) & 0xff] ^
                        T8[ t[(i + 1) % 4]        & 0xff] ^
                        this._Kd[r][i]);
            }
            t = a.slice(0);
        }

        // the last round is special
        var result = createBuffer(16), tt;
        for (var i = 0; i < 4; i++) {
            tt = this._Kd[rounds][i];
            result[4 * i    ] = (Si[(t[ i         ] >> 24) & 0xff] ^ (tt >> 24)) & 0xff;
            result[4 * i + 1] = (Si[(t[(i + 3) % 4] >> 16) & 0xff] ^ (tt >> 16)) & 0xff;
            result[4 * i + 2] = (Si[(t[(i + 2) % 4] >>  8) & 0xff] ^ (tt >>  8)) & 0xff;
            result[4 * i + 3] = (Si[ t[(i + 1) % 4]        & 0xff] ^  tt       ) & 0xff;
        }

        return result;
    }


    /**
     *  Mode Of Operation - Electonic Codebook (ECB)
     */
    var ModeOfOperationECB = function(key) {
        if (!(this instanceof ModeOfOperationECB)) {
            throw Error('AES must be instanitated with `new`');
        }

        this.description = "Electronic Code Block";
        this.name = "ecb";

        this._aes = new AES(key);
    }

    ModeOfOperationECB.prototype.encrypt = function(plaintext) {
        return this._aes.encrypt(plaintext);
    }

    ModeOfOperationECB.prototype.decrypt = function(ciphertext, encoding) {
        return this._aes.decrypt(ciphertext);
    }


    /**
     *  Mode Of Operation - Cipher Block Chaining (CBC)
     */
    var ModeOfOperationCBC = function(key, iv) {
        if (!(this instanceof ModeOfOperationCBC)) {
            throw Error('AES must be instanitated with `new`');
        }

        this.description = "Cipher Block Chaining";
        this.name = "cbc";

        if (!iv) {
            iv = createBuffer([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]);

        } else if (iv.length != 16) {
            throw new Error('invalid initialation vector size (must be 16 bytes)');
        }

        this._lastCipherblock = createBuffer(iv);

        this._aes = new AES(key);
    }

    ModeOfOperationCBC.prototype.encrypt = function(plaintext) {
        if (plaintext.length != 16) {
            throw new Error('invalid plaintext size (must be 16 bytes)');
        }

        var precipherblock = createBuffer(plaintext);
        for (var i = 0; i < 16; i++) {
            precipherblock[i] ^= this._lastCipherblock[i];
        }

        this._lastCipherblock = this._aes.encrypt(precipherblock);

        return this._lastCipherblock;
    }

    ModeOfOperationCBC.prototype.decrypt = function(ciphertext) {
        if (ciphertext.length != 16) {
            throw new Error('invalid ciphertext size (must be 16 bytes)');
        }

        var plaintext = this._aes.decrypt(ciphertext);
        for (var i = 0; i < 16; i++) {
            plaintext[i] ^= this._lastCipherblock[i];
        }

        copyBuffer(ciphertext, this._lastCipherblock);

        return plaintext;
    }


    /**
     *  Mode Of Operation - Cipher Feedback (CFB)
     */
    var ModeOfOperationCFB = function(key, iv, segmentSize) {
        if (!(this instanceof ModeOfOperationCFB)) {
            throw Error('AES must be instanitated with `new`');
        }

        this.description = "Cipher Feedback";
        this.name = "cfb";

        if (!iv) {
            iv = createBuffer([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]);

        } else if (iv.length != 16) {
            throw new Error('invalid initialation vector size (must be 16 size)');
        }

        if (!segmentSize) { segmentSize = 1; }

        this.segmentSize = segmentSize;

        this._shiftRegister = createBuffer(iv);

        this._aes = new AES(key);
    }

    ModeOfOperationCFB.prototype.encrypt = function(plaintext) {
        if ((plaintext.length % this.segmentSize) != 0) {
            throw new Error('invalid plaintext size (must be segmentSize bytes)');
        }

        var encrypted = createBuffer(plaintext);

        var xorSegment;
        for (var i = 0; i < encrypted.length; i += this.segmentSize) {
            xorSegment = this._aes.encrypt(this._shiftRegister);
            for (var j = 0; j < this.segmentSize; j++) {
                encrypted[i + j] ^= xorSegment[j];
            }

            // Shift the register
            copyBuffer(this._shiftRegister, this._shiftRegister, 0, this.segmentSize);
            copyBuffer(encrypted, this._shiftRegister, 16 - this.segmentSize, i, i + this.segmentSize);
        }

        return encrypted;
    }

    ModeOfOperationCFB.prototype.decrypt = function(ciphertext) {
        if ((ciphertext.length % this.segmentSize) != 0) {
            throw new Error('invalid ciphertext size (must be segmentSize bytes)');
        }

        var plaintext = createBuffer(ciphertext);

        var xorSegment;
        for (var i = 0; i < plaintext.length; i += this.segmentSize) {
            xorSegment = this._aes.encrypt(this._shiftRegister);

            for (var j = 0; j < this.segmentSize; j++) {
                plaintext[i + j] ^= xorSegment[j];
            }

            // Shift the register
            copyBuffer(this._shiftRegister, this._shiftRegister, 0, this.segmentSize);
            copyBuffer(ciphertext, this._shiftRegister, 16 - this.segmentSize, i, i + this.segmentSize);
        }

        return plaintext;
    }

    /**
     *  Mode Of Operation - Output Feedback (OFB)
     */
    var ModeOfOperationOFB = function(key, iv) {
        if (!(this instanceof ModeOfOperationOFB)) {
            throw Error('AES must be instanitated with `new`');
        }

        this.description = "Output Feedback";
        this.name = "ofb";

        if (!iv) {
            iv = createBuffer([0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]);

        } else if (iv.length != 16) {
            throw new Error('invalid initialation vector size (must be 16 bytes)');
        }

        this._lastPrecipher = createBuffer(iv);
        this._lastPrecipherIndex = 16;

        this._aes = new AES(key);
    }

    ModeOfOperationOFB.prototype.encrypt = function(plaintext) {
        var encrypted = createBuffer(plaintext);

        for (var i = 0; i < encrypted.length; i++) {
            if (this._lastPrecipherIndex === 16) {
                this._lastPrecipher = this._aes.encrypt(this._lastPrecipher);
                this._lastPrecipherIndex = 0;
            }
            encrypted[i] ^= this._lastPrecipher[this._lastPrecipherIndex++];
        }

        return encrypted;
    }

    // Decryption is symetric
    ModeOfOperationOFB.prototype.decrypt = ModeOfOperationOFB.prototype.encrypt;


    /**
     *  Counter object for CTR common mode of operation
     */
    var Counter = function(initialValue) {
        if (!(this instanceof Counter)) {
            throw Error('Counter must be instanitated with `new`');
        }

        // We allow 0, but anything false-ish uses the default 1
        if (initialValue !== 0 && !initialValue) { initialValue = 1; }

        if (typeof(initialValue) === 'number') {
            this._counter = createBuffer([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]);
            this.setValue(initialValue);

        } else {
            this.setBytes(initialValue);
        }
    }

    Counter.prototype.setValue = function(value) {
        if (typeof(value) !== 'number' || parseInt(value) != value) {
            throw new Error('invalid counter value (must be an integer)');
        }

        for (var index = 15; index >= 0; --index) {
            this._counter[index] = value % 256;
            value = value >> 8;
        }
    }

    Counter.prototype.setBytes = function(bytes) {
        if (bytes.length != 16) {
            throw new Error('invalid counter bytes size (must be 16 bytes)');
        }
        this._counter = createBuffer(bytes);
    };

    Counter.prototype.increment = function() {
        for (var i = 15; i >= 0; i--) {
            if (this._counter[i] === 255) {
                this._counter[i] = 0;
            } else {
                this._counter[i]++;
                break;
            }
        }
    }


    /**
     *  Mode Of Operation - Counter (CTR)
     */
    var ModeOfOperationCTR = function(key, counter) {
        if (!(this instanceof ModeOfOperationCTR)) {
            throw Error('AES must be instanitated with `new`');
        }

        this.description = "Counter";
        this.name = "ctr";

        if (!(counter instanceof Counter)) {
            counter = new Counter(counter)
        }

        this._counter = counter;

        this._remainingCounter = null;
        this._remainingCounterIndex = 16;

        this._aes = new AES(key);
    }

    ModeOfOperationCTR.prototype.encrypt = function(plaintext) {
        var encrypted = createBuffer(plaintext);

        for (var i = 0; i < encrypted.length; i++) {
            if (this._remainingCounterIndex === 16) {
                this._remainingCounter = this._aes.encrypt(this._counter._counter);
                this._remainingCounterIndex = 0;
                this._counter.increment();
            }
            encrypted[i] ^= this._remainingCounter[this._remainingCounterIndex++];
        }

        return encrypted;
    }

    // Decryption is symetric
    ModeOfOperationCTR.prototype.decrypt = ModeOfOperationCTR.prototype.encrypt;


    // The bsic modes of operation as a map
    var ModeOfOperation = {
        ecb: ModeOfOperationECB,
        cbc: ModeOfOperationCBC,
        cfb: ModeOfOperationCFB,
        ofb: ModeOfOperationOFB,
        ctr: ModeOfOperationCTR
    };


    ///////////////////////
    // Exporting


    // The block cipher
    var aesjs = {
        AES: AES,
        Counter: Counter,
        ModeOfOperation: ModeOfOperation,
        util: {
            convertBytesToString: convertBytesToString,
            convertStringToBytes: convertStringToBytes,
            _slowCreateBuffer: slowCreateBuffer
        }
    };


    // node.js
    if (typeof exports !== 'undefined') {
        module.exports = aesjs

    // RequireJS/AMD
    // http://www.requirejs.org/docs/api.html
    // https://github.com/amdjs/amdjs-api/wiki/AMD
    } else if (typeof(define) === 'function' && define.amd) {
        define(aesjs);

    // Web Browsers
    } else {

        // If there was an existing library at "aes" make sure it's still available
        if (root.aes) {
            aesjs._aes = root.aes;
        }

        root.aesjs = aesjs;
    }


})(this);

// ============= END AES =============


// =========== BEGIN HMAC ===========


/*
 A JavaScript implementation of the SHA family of hashes, as
 defined in FIPS PUB 180-4 and FIPS PUB 202, as well as the corresponding
 HMAC implementation as defined in FIPS PUB 198a

 Copyright Brian Turek 2008-2016
 Distributed under the BSD License
 See http://caligatio.github.com/jsSHA/ for more information

 Several functions taken from Paul Johnston
*/
'use strict';
(function(X) {
    function C(f, b, c) {
        var d = 0,
            a = [],
            k = 0,
            g, e, n, h, m, r, t, q, v = !1,
            u = [],
            w = [],
            x, y = !1,
            z = !1;
        c = c || {};
        g = c.encoding || "UTF8";
        x = c.numRounds || 1;
        n = J(b, g);
        if (x !== parseInt(x, 10) || 1 > x) throw Error("numRounds must a integer >= 1");
        if ("SHA-1" === f) m = 512, r = K, t = Y, h = 160, q = function(b) {
            return b.slice()
        };
        else if (0 === f.lastIndexOf("SHA-", 0))
            if (r = function(b, d) {
                    return L(b, d, f)
                }, t = function(b, d, c, a) {
                    var l, k;
                    if ("SHA-224" === f || "SHA-256" === f) l = (d + 65 >>> 9 << 4) + 15, k = 16;
                    else if ("SHA-384" === f || "SHA-512" === f) l = (d + 129 >>>
                        10 << 5) + 31, k = 32;
                    else throw Error("Unexpected error in SHA-2 implementation");
                    for (; b.length <= l;) b.push(0);
                    b[d >>> 5] |= 128 << 24 - d % 32;
                    d = d + c;
                    b[l] = d & 4294967295;
                    b[l - 1] = d / 4294967296 | 0;
                    c = b.length;
                    for (d = 0; d < c; d += k) a = L(b.slice(d, d + k), a, f);
                    if ("SHA-224" === f) b = [a[0], a[1], a[2], a[3], a[4], a[5], a[6]];
                    else if ("SHA-256" === f) b = a;
                    else if ("SHA-384" === f) b = [a[0].a, a[0].b, a[1].a, a[1].b, a[2].a, a[2].b, a[3].a, a[3].b, a[4].a, a[4].b, a[5].a, a[5].b];
                    else if ("SHA-512" === f) b = [a[0].a, a[0].b, a[1].a, a[1].b, a[2].a, a[2].b, a[3].a, a[3].b, a[4].a,
                        a[4].b, a[5].a, a[5].b, a[6].a, a[6].b, a[7].a, a[7].b
                    ];
                    else throw Error("Unexpected error in SHA-2 implementation");
                    return b
                }, q = function(b) {
                    return b.slice()
                }, "SHA-224" === f) m = 512, h = 224;
            else if ("SHA-256" === f) m = 512, h = 256;
        else if ("SHA-384" === f) m = 1024, h = 384;
        else if ("SHA-512" === f) m = 1024, h = 512;
        else throw Error("Chosen SHA variant is not supported");
        else if (0 === f.lastIndexOf("SHA3-", 0) || 0 === f.lastIndexOf("SHAKE", 0)) {
            var F = 6;
            r = D;
            q = function(b) {
                var f = [],
                    a;
                for (a = 0; 5 > a; a += 1) f[a] = b[a].slice();
                return f
            };
            if ("SHA3-224" ===
                f) m = 1152, h = 224;
            else if ("SHA3-256" === f) m = 1088, h = 256;
            else if ("SHA3-384" === f) m = 832, h = 384;
            else if ("SHA3-512" === f) m = 576, h = 512;
            else if ("SHAKE128" === f) m = 1344, h = -1, F = 31, z = !0;
            else if ("SHAKE256" === f) m = 1088, h = -1, F = 31, z = !0;
            else throw Error("Chosen SHA variant is not supported");
            t = function(b, f, a, d, c) {
                a = m;
                var l = F,
                    k, g = [],
                    e = a >>> 5,
                    h = 0,
                    p = f >>> 5;
                for (k = 0; k < p && f >= a; k += e) d = D(b.slice(k, k + e), d), f -= a;
                b = b.slice(k);
                for (f %= a; b.length < e;) b.push(0);
                k = f >>> 3;
                b[k >> 2] ^= l << 24 - k % 4 * 8;
                b[e - 1] ^= 128;
                for (d = D(b, d); 32 * g.length < c;) {
                    b = d[h % 5][h /
                        5 | 0
                    ];
                    g.push((b.b & 255) << 24 | (b.b & 65280) << 8 | (b.b & 16711680) >> 8 | b.b >>> 24);
                    if (32 * g.length >= c) break;
                    g.push((b.a & 255) << 24 | (b.a & 65280) << 8 | (b.a & 16711680) >> 8 | b.a >>> 24);
                    h += 1;
                    0 === 64 * h % a && D(null, d)
                }
                return g
            }
        } else throw Error("Chosen SHA variant is not supported");
        e = B(f);
        this.setHMACKey = function(b, a, c) {
            var l;
            if (!0 === v) throw Error("HMAC key already set");
            if (!0 === y) throw Error("Cannot set HMAC key after calling update");
            if (!0 === z) throw Error("SHAKE is not supported for HMAC");
            g = (c || {}).encoding || "UTF8";
            a = J(a, g)(b);
            b = a.binLen;
            a = a.value;
            l = m >>> 3;
            c = l / 4 - 1;
            if (l < b / 8) {
                for (a = t(a, b, 0, B(f), h); a.length <= c;) a.push(0);
                a[c] &= 4294967040
            } else if (l > b / 8) {
                for (; a.length <= c;) a.push(0);
                a[c] &= 4294967040
            }
            for (b = 0; b <= c; b += 1) u[b] = a[b] ^ 909522486, w[b] = a[b] ^ 1549556828;
            e = r(u, e);
            d = m;
            v = !0
        };
        this.update = function(b) {
            var f, c, g, h = 0,
                q = m >>> 5;
            f = n(b, a, k);
            b = f.binLen;
            c = f.value;
            f = b >>> 5;
            for (g = 0; g < f; g += q) h + m <= b && (e = r(c.slice(g, g + q), e), h += m);
            d += h;
            a = c.slice(h >>> 5);
            k = b % m;
            y = !0
        };
        this.getHash = function(b, c) {
            var g, m, n, r;
            if (!0 === v) throw Error("Cannot call getHash after setting HMAC key");
            n = M(c);
            if (!0 === z) {
                if (-1 === n.shakeLen) throw Error("shakeLen must be specified in options");
                h = n.shakeLen
            }
            switch (b) {
                case "HEX":
                    g = function(b) {
                        return N(b, h, n)
                    };
                    break;
                case "B64":
                    g = function(b) {
                        return O(b, h, n)
                    };
                    break;
                case "BYTES":
                    g = function(b) {
                        return P(b, h)
                    };
                    break;
                case "ARRAYBUFFER":
                    try {
                        m = new ArrayBuffer(0)
                    } catch (sa) {
                        throw Error("ARRAYBUFFER not supported by this environment");
                    }
                    g = function(b) {
                        return Q(b, h)
                    };
                    break;
                default:
                    throw Error("format must be HEX, B64, BYTES, or ARRAYBUFFER");
            }
            r = t(a.slice(), k, d, q(e),
                h);
            for (m = 1; m < x; m += 1) !0 === z && 0 !== h % 32 && (r[r.length - 1] &= 4294967040 << 24 - h % 32), r = t(r, h, 0, B(f), h);
            return g(r)
        };
        this.getHMAC = function(b, c) {
            var g, n, u, x;
            if (!1 === v) throw Error("Cannot call getHMAC without first setting HMAC key");
            u = M(c);
            switch (b) {
                case "HEX":
                    g = function(b) {
                        return N(b, h, u)
                    };
                    break;
                case "B64":
                    g = function(b) {
                        return O(b, h, u)
                    };
                    break;
                case "BYTES":
                    g = function(b) {
                        return P(b, h)
                    };
                    break;
                case "ARRAYBUFFER":
                    try {
                        g = new ArrayBuffer(0)
                    } catch (z) {
                        throw Error("ARRAYBUFFER not supported by this environment");
                    }
                    g = function(b) {
                        return Q(b,
                            h)
                    };
                    break;
                default:
                    throw Error("outputFormat must be HEX, B64, BYTES, or ARRAYBUFFER");
            }
            n = t(a.slice(), k, d, q(e), h);
            x = r(w, B(f));
            x = t(n, h, m, x, h);
            return g(x)
        }
    }

    function a(f, b) {
        this.a = f;
        this.b = b
    }

    function Z(f, b, a) {
        var d = f.length,
            l, k, g, e, n;
        b = b || [0];
        a = a || 0;
        n = a >>> 3;
        if (0 !== d % 2) throw Error("String of HEX type must be in byte increments");
        for (l = 0; l < d; l += 2) {
            k = parseInt(f.substr(l, 2), 16);
            if (isNaN(k)) throw Error("String of HEX type contains invalid characters");
            e = (l >>> 1) + n;
            for (g = e >>> 2; b.length <= g;) b.push(0);
            b[g] |= k <<
                8 * (3 - e % 4)
        }
        return {
            value: b,
            binLen: 4 * d + a
        }
    }

    function aa(f, b, a) {
        var d = [],
            l, k, g, e, d = b || [0];
        a = a || 0;
        k = a >>> 3;
        for (l = 0; l < f.length; l += 1) b = f.charCodeAt(l), e = l + k, g = e >>> 2, d.length <= g && d.push(0), d[g] |= b << 8 * (3 - e % 4);
        return {
            value: d,
            binLen: 8 * f.length + a
        }
    }

    function ba(f, b, a) {
        var d = [],
            l = 0,
            k, g, e, n, h, m, d = b || [0];
        a = a || 0;
        b = a >>> 3;
        if (-1 === f.search(/^[a-zA-Z0-9=+\/]+$/)) throw Error("Invalid character in base-64 string");
        g = f.indexOf("=");
        f = f.replace(/\=/g, "");
        if (-1 !== g && g < f.length) throw Error("Invalid '=' found in base-64 string");
        for (g = 0; g < f.length; g += 4) {
            h = f.substr(g, 4);
            for (e = n = 0; e < h.length; e += 1) k = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(h[e]), n |= k << 18 - 6 * e;
            for (e = 0; e < h.length - 1; e += 1) {
                m = l + b;
                for (k = m >>> 2; d.length <= k;) d.push(0);
                d[k] |= (n >>> 16 - 8 * e & 255) << 8 * (3 - m % 4);
                l += 1
            }
        }
        return {
            value: d,
            binLen: 8 * l + a
        }
    }

    function ca(a, b, c) {
        var d = [],
            l, k, g, d = b || [0];
        c = c || 0;
        l = c >>> 3;
        for (b = 0; b < a.byteLength; b += 1) g = b + l, k = g >>> 2, d.length <= k && d.push(0), d[k] |= a[b] << 8 * (3 - g % 4);
        return {
            value: d,
            binLen: 8 * a.byteLength + c
        }
    }

    function N(a, b, c) {
        var d =
            "";
        b /= 8;
        var l, k;
        for (l = 0; l < b; l += 1) k = a[l >>> 2] >>> 8 * (3 - l % 4), d += "0123456789abcdef".charAt(k >>> 4 & 15) + "0123456789abcdef".charAt(k & 15);
        return c.outputUpper ? d.toUpperCase() : d
    }

    function O(a, b, c) {
        var d = "",
            l = b / 8,
            k, g, e;
        for (k = 0; k < l; k += 3)
            for (g = k + 1 < l ? a[k + 1 >>> 2] : 0, e = k + 2 < l ? a[k + 2 >>> 2] : 0, e = (a[k >>> 2] >>> 8 * (3 - k % 4) & 255) << 16 | (g >>> 8 * (3 - (k + 1) % 4) & 255) << 8 | e >>> 8 * (3 - (k + 2) % 4) & 255, g = 0; 4 > g; g += 1) 8 * k + 6 * g <= b ? d += "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e >>> 6 * (3 - g) & 63) : d += c.b64Pad;
        return d
    }

    function P(a,
        b) {
        var c = "",
            d = b / 8,
            l, k;
        for (l = 0; l < d; l += 1) k = a[l >>> 2] >>> 8 * (3 - l % 4) & 255, c += String.fromCharCode(k);
        return c
    }

    function Q(a, b) {
        var c = b / 8,
            d, l = new ArrayBuffer(c);
        for (d = 0; d < c; d += 1) l[d] = a[d >>> 2] >>> 8 * (3 - d % 4) & 255;
        return l
    }

    function M(a) {
        var b = {
            outputUpper: !1,
            b64Pad: "=",
            shakeLen: -1
        };
        a = a || {};
        b.outputUpper = a.outputUpper || !1;
        !0 === a.hasOwnProperty("b64Pad") && (b.b64Pad = a.b64Pad);
        if (!0 === a.hasOwnProperty("shakeLen")) {
            if (0 !== a.shakeLen % 8) throw Error("shakeLen must be a multiple of 8");
            b.shakeLen = a.shakeLen
        }
        if ("boolean" !==
            typeof b.outputUpper) throw Error("Invalid outputUpper formatting option");
        if ("string" !== typeof b.b64Pad) throw Error("Invalid b64Pad formatting option");
        return b
    }

    function J(a, b) {
        var c;
        switch (b) {
            case "UTF8":
            case "UTF16BE":
            case "UTF16LE":
                break;
            default:
                throw Error("encoding must be UTF8, UTF16BE, or UTF16LE");
        }
        switch (a) {
            case "HEX":
                c = Z;
                break;
            case "TEXT":
                c = function(a, f, c) {
                    var e = [],
                        p = [],
                        n = 0,
                        h, m, r, t, q, e = f || [0];
                    f = c || 0;
                    r = f >>> 3;
                    if ("UTF8" === b)
                        for (h = 0; h < a.length; h += 1)
                            for (c = a.charCodeAt(h), p = [], 128 > c ? p.push(c) :
                                2048 > c ? (p.push(192 | c >>> 6), p.push(128 | c & 63)) : 55296 > c || 57344 <= c ? p.push(224 | c >>> 12, 128 | c >>> 6 & 63, 128 | c & 63) : (h += 1, c = 65536 + ((c & 1023) << 10 | a.charCodeAt(h) & 1023), p.push(240 | c >>> 18, 128 | c >>> 12 & 63, 128 | c >>> 6 & 63, 128 | c & 63)), m = 0; m < p.length; m += 1) {
                                q = n + r;
                                for (t = q >>> 2; e.length <= t;) e.push(0);
                                e[t] |= p[m] << 8 * (3 - q % 4);
                                n += 1
                            } else if ("UTF16BE" === b || "UTF16LE" === b)
                                for (h = 0; h < a.length; h += 1) {
                                    c = a.charCodeAt(h);
                                    "UTF16LE" === b && (m = c & 255, c = m << 8 | c >>> 8);
                                    q = n + r;
                                    for (t = q >>> 2; e.length <= t;) e.push(0);
                                    e[t] |= c << 8 * (2 - q % 4);
                                    n += 2
                                }
                            return {
                                value: e,
                                binLen: 8 *
                                    n + f
                            }
                };
                break;
            case "B64":
                c = ba;
                break;
            case "BYTES":
                c = aa;
                break;
            case "ARRAYBUFFER":
                try {
                    c = new ArrayBuffer(0)
                } catch (d) {
                    throw Error("ARRAYBUFFER not supported by this environment");
                }
                c = ca;
                break;
            default:
                throw Error("format must be HEX, TEXT, B64, BYTES, or ARRAYBUFFER");
        }
        return c
    }

    function y(a, b) {
        return a << b | a >>> 32 - b
    }

    function R(f, b) {
        return 32 < b ? (b = b - 32, new a(f.b << b | f.a >>> 32 - b, f.a << b | f.b >>> 32 - b)) : 0 !== b ? new a(f.a << b | f.b >>> 32 - b, f.b << b | f.a >>> 32 - b) : f
    }

    function v(a, b) {
        return a >>> b | a << 32 - b
    }

    function w(f, b) {
        var c = null,
            c = new a(f.a, f.b);
        return c = 32 >= b ? new a(c.a >>> b | c.b << 32 - b & 4294967295, c.b >>> b | c.a << 32 - b & 4294967295) : new a(c.b >>> b - 32 | c.a << 64 - b & 4294967295, c.a >>> b - 32 | c.b << 64 - b & 4294967295)
    }

    function S(f, b) {
        var c = null;
        return c = 32 >= b ? new a(f.a >>> b, f.b >>> b | f.a << 32 - b & 4294967295) : new a(0, f.a >>> b - 32)
    }

    function da(a, b, c) {
        return a & b ^ ~a & c
    }

    function ea(f, b, c) {
        return new a(f.a & b.a ^ ~f.a & c.a, f.b & b.b ^ ~f.b & c.b)
    }

    function T(a, b, c) {
        return a & b ^ a & c ^ b & c
    }

    function fa(f, b, c) {
        return new a(f.a & b.a ^ f.a & c.a ^ b.a & c.a, f.b & b.b ^ f.b & c.b ^ b.b & c.b)
    }

    function ga(a) {
        return v(a,
            2) ^ v(a, 13) ^ v(a, 22)
    }

    function ha(f) {
        var b = w(f, 28),
            c = w(f, 34);
        f = w(f, 39);
        return new a(b.a ^ c.a ^ f.a, b.b ^ c.b ^ f.b)
    }

    function ia(a) {
        return v(a, 6) ^ v(a, 11) ^ v(a, 25)
    }

    function ja(f) {
        var b = w(f, 14),
            c = w(f, 18);
        f = w(f, 41);
        return new a(b.a ^ c.a ^ f.a, b.b ^ c.b ^ f.b)
    }

    function ka(a) {
        return v(a, 7) ^ v(a, 18) ^ a >>> 3
    }

    function la(f) {
        var b = w(f, 1),
            c = w(f, 8);
        f = S(f, 7);
        return new a(b.a ^ c.a ^ f.a, b.b ^ c.b ^ f.b)
    }

    function ma(a) {
        return v(a, 17) ^ v(a, 19) ^ a >>> 10
    }

    function na(f) {
        var b = w(f, 19),
            c = w(f, 61);
        f = S(f, 6);
        return new a(b.a ^ c.a ^ f.a, b.b ^ c.b ^ f.b)
    }

    function G(a,
        b) {
        var c = (a & 65535) + (b & 65535);
        return ((a >>> 16) + (b >>> 16) + (c >>> 16) & 65535) << 16 | c & 65535
    }

    function oa(a, b, c, d) {
        var l = (a & 65535) + (b & 65535) + (c & 65535) + (d & 65535);
        return ((a >>> 16) + (b >>> 16) + (c >>> 16) + (d >>> 16) + (l >>> 16) & 65535) << 16 | l & 65535
    }

    function H(a, b, c, d, l) {
        var e = (a & 65535) + (b & 65535) + (c & 65535) + (d & 65535) + (l & 65535);
        return ((a >>> 16) + (b >>> 16) + (c >>> 16) + (d >>> 16) + (l >>> 16) + (e >>> 16) & 65535) << 16 | e & 65535
    }

    function pa(f, b) {
        var c, d, l;
        c = (f.b & 65535) + (b.b & 65535);
        d = (f.b >>> 16) + (b.b >>> 16) + (c >>> 16);
        l = (d & 65535) << 16 | c & 65535;
        c = (f.a & 65535) +
            (b.a & 65535) + (d >>> 16);
        d = (f.a >>> 16) + (b.a >>> 16) + (c >>> 16);
        return new a((d & 65535) << 16 | c & 65535, l)
    }

    function qa(f, b, c, d) {
        var l, e, g;
        l = (f.b & 65535) + (b.b & 65535) + (c.b & 65535) + (d.b & 65535);
        e = (f.b >>> 16) + (b.b >>> 16) + (c.b >>> 16) + (d.b >>> 16) + (l >>> 16);
        g = (e & 65535) << 16 | l & 65535;
        l = (f.a & 65535) + (b.a & 65535) + (c.a & 65535) + (d.a & 65535) + (e >>> 16);
        e = (f.a >>> 16) + (b.a >>> 16) + (c.a >>> 16) + (d.a >>> 16) + (l >>> 16);
        return new a((e & 65535) << 16 | l & 65535, g)
    }

    function ra(f, b, c, d, l) {
        var e, g, p;
        e = (f.b & 65535) + (b.b & 65535) + (c.b & 65535) + (d.b & 65535) + (l.b & 65535);
        g =
            (f.b >>> 16) + (b.b >>> 16) + (c.b >>> 16) + (d.b >>> 16) + (l.b >>> 16) + (e >>> 16);
        p = (g & 65535) << 16 | e & 65535;
        e = (f.a & 65535) + (b.a & 65535) + (c.a & 65535) + (d.a & 65535) + (l.a & 65535) + (g >>> 16);
        g = (f.a >>> 16) + (b.a >>> 16) + (c.a >>> 16) + (d.a >>> 16) + (l.a >>> 16) + (e >>> 16);
        return new a((g & 65535) << 16 | e & 65535, p)
    }

    function A(f) {
        var b = 0,
            c = 0,
            d;
        for (d = 0; d < arguments.length; d += 1) b ^= arguments[d].b, c ^= arguments[d].a;
        return new a(c, b)
    }

    function B(f) {
        var b = [],
            c;
        if ("SHA-1" === f) b = [1732584193, 4023233417, 2562383102, 271733878, 3285377520];
        else if (0 === f.lastIndexOf("SHA-",
                0)) switch (b = [3238371032, 914150663, 812702999, 4144912697, 4290775857, 1750603025, 1694076839, 3204075428], c = [1779033703, 3144134277, 1013904242, 2773480762, 1359893119, 2600822924, 528734635, 1541459225], f) {
                case "SHA-224":
                    break;
                case "SHA-256":
                    b = c;
                    break;
                case "SHA-384":
                    b = [new a(3418070365, b[0]), new a(1654270250, b[1]), new a(2438529370, b[2]), new a(355462360, b[3]), new a(1731405415, b[4]), new a(41048885895, b[5]), new a(3675008525, b[6]), new a(1203062813, b[7])];
                    break;
                case "SHA-512":
                    b = [new a(c[0], 4089235720), new a(c[1],
                        2227873595), new a(c[2], 4271175723), new a(c[3], 1595750129), new a(c[4], 2917565137), new a(c[5], 725511199), new a(c[6], 4215389547), new a(c[7], 327033209)];
                    break;
                default:
                    throw Error("Unknown SHA variant");
            } else if (0 === f.lastIndexOf("SHA3-", 0) || 0 === f.lastIndexOf("SHAKE", 0))
                for (f = 0; 5 > f; f += 1) b[f] = [new a(0, 0), new a(0, 0), new a(0, 0), new a(0, 0), new a(0, 0)];
            else throw Error("No SHA variants supported");
        return b
    }

    function K(a, b) {
        var c = [],
            d, e, k, g, p, n, h;
        d = b[0];
        e = b[1];
        k = b[2];
        g = b[3];
        p = b[4];
        for (h = 0; 80 > h; h += 1) c[h] = 16 > h ?
            a[h] : y(c[h - 3] ^ c[h - 8] ^ c[h - 14] ^ c[h - 16], 1), n = 20 > h ? H(y(d, 5), e & k ^ ~e & g, p, 1518500249, c[h]) : 40 > h ? H(y(d, 5), e ^ k ^ g, p, 1859775393, c[h]) : 60 > h ? H(y(d, 5), T(e, k, g), p, 2400959708, c[h]) : H(y(d, 5), e ^ k ^ g, p, 3395469782, c[h]), p = g, g = k, k = y(e, 30), e = d, d = n;
        b[0] = G(d, b[0]);
        b[1] = G(e, b[1]);
        b[2] = G(k, b[2]);
        b[3] = G(g, b[3]);
        b[4] = G(p, b[4]);
        return b
    }

    function Y(a, b, c, d) {
        var e;
        for (e = (b + 65 >>> 9 << 4) + 15; a.length <= e;) a.push(0);
        a[b >>> 5] |= 128 << 24 - b % 32;
        b += c;
        a[e] = b & 4294967295;
        a[e - 1] = b / 4294967296 | 0;
        b = a.length;
        for (e = 0; e < b; e += 16) d = K(a.slice(e, e + 16), d);
        return d
    }

    function L(f, b, c) {
        var d, l, k, g, p, n, h, m, r, t, q, v, u, w, x, y, z, F, A, B, C, D, E = [],
            I;
        if ("SHA-224" === c || "SHA-256" === c) t = 64, v = 1, D = Number, u = G, w = oa, x = H, y = ka, z = ma, F = ga, A = ia, C = T, B = da, I = e;
        else if ("SHA-384" === c || "SHA-512" === c) t = 80, v = 2, D = a, u = pa, w = qa, x = ra, y = la, z = na, F = ha, A = ja, C = fa, B = ea, I = U;
        else throw Error("Unexpected error in SHA-2 implementation");
        c = b[0];
        d = b[1];
        l = b[2];
        k = b[3];
        g = b[4];
        p = b[5];
        n = b[6];
        h = b[7];
        for (q = 0; q < t; q += 1) 16 > q ? (r = q * v, m = f.length <= r ? 0 : f[r], r = f.length <= r + 1 ? 0 : f[r + 1], E[q] = new D(m, r)) : E[q] = w(z(E[q - 2]),
            E[q - 7], y(E[q - 15]), E[q - 16]), m = x(h, A(g), B(g, p, n), I[q], E[q]), r = u(F(c), C(c, d, l)), h = n, n = p, p = g, g = u(k, m), k = l, l = d, d = c, c = u(m, r);
        b[0] = u(c, b[0]);
        b[1] = u(d, b[1]);
        b[2] = u(l, b[2]);
        b[3] = u(k, b[3]);
        b[4] = u(g, b[4]);
        b[5] = u(p, b[5]);
        b[6] = u(n, b[6]);
        b[7] = u(h, b[7]);
        return b
    }

    function D(f, b) {
        var c, d, e, k, g = [],
            p = [];
        if (null !== f)
            for (d = 0; d < f.length; d += 2) b[(d >>> 1) % 5][(d >>> 1) / 5 | 0] = A(b[(d >>> 1) % 5][(d >>> 1) / 5 | 0], new a((f[d + 1] & 255) << 24 | (f[d + 1] & 65280) << 8 | (f[d + 1] & 16711680) >>> 8 | f[d + 1] >>> 24, (f[d] & 255) << 24 | (f[d] & 65280) << 8 | (f[d] & 16711680) >>> 8 |
                f[d] >>> 24));
        for (c = 0; 24 > c; c += 1) {
            k = B("SHA3-");
            for (d = 0; 5 > d; d += 1) g[d] = A(b[d][0], b[d][1], b[d][2], b[d][3], b[d][4]);
            for (d = 0; 5 > d; d += 1) p[d] = A(g[(d + 4) % 5], R(g[(d + 1) % 5], 1));
            for (d = 0; 5 > d; d += 1)
                for (e = 0; 5 > e; e += 1) b[d][e] = A(b[d][e], p[d]);
            for (d = 0; 5 > d; d += 1)
                for (e = 0; 5 > e; e += 1) k[e][(2 * d + 3 * e) % 5] = R(b[d][e], V[d][e]);
            for (d = 0; 5 > d; d += 1)
                for (e = 0; 5 > e; e += 1) b[d][e] = A(k[d][e], new a(~k[(d + 1) % 5][e].a & k[(d + 2) % 5][e].a, ~k[(d + 1) % 5][e].b & k[(d + 2) % 5][e].b));
            b[0][0] = A(b[0][0], W[c])
        }
        return b
    }
    var e, U, V, W;
    e = [1116352408, 1899447441, 3049323471, 3921009573,
        961987163, 1508970993, 2453635748, 2870763221, 3624381080, 310598401, 607225278, 1426881987, 1925078388, 2162078206, 2614888103, 3248222580, 3835390401, 4022224774, 264347078, 604807628, 770255983, 1249150122, 1555081692, 1996064986, 2554220882, 2821834349, 2952996808, 3210313671, 3336571891, 3584528711, 113926993, 338241895, 666307205, 773529912, 1294757372, 1396182291, 1695183700, 1986661051, 2177026350, 2456956037, 2730485921, 2820302411, 3259730800, 3345764771, 3516065817, 3600352804, 4094571909, 275423344, 430227734, 506948616, 659060556,
        883997877, 958139571, 1322822218, 1537002063, 1747873779, 1955562222, 2024104815, 2227730452, 2361852424, 2428436474, 2756734187, 3204031479, 3329325298
    ];
    U = [new a(e[0], 3609767458), new a(e[1], 602891725), new a(e[2], 3964484399), new a(e[3], 2173295548), new a(e[4], 4081628472), new a(e[5], 3053834265), new a(e[6], 2937671579), new a(e[7], 3664609560), new a(e[8], 2734883394), new a(e[9], 1164996542), new a(e[10], 1323610764), new a(e[11], 3590304994), new a(e[12], 4068182383), new a(e[13], 991336113), new a(e[14], 633803317), new a(e[15],
        3479774868), new a(e[16], 2666613458), new a(e[17], 944711139), new a(e[18], 2341262773), new a(e[19], 2007800933), new a(e[20], 1495990901), new a(e[21], 1856431235), new a(e[22], 3175218132), new a(e[23], 2198950837), new a(e[24], 3999719339), new a(e[25], 766784016), new a(e[26], 2566594879), new a(e[27], 3203337956), new a(e[28], 1034457026), new a(e[29], 2466948901), new a(e[30], 3758326383), new a(e[31], 168717936), new a(e[32], 1188179964), new a(e[33], 1546045734), new a(e[34], 1522805485), new a(e[35], 2643833823), new a(e[36],
        2343527390), new a(e[37], 1014477480), new a(e[38], 1206759142), new a(e[39], 344077627), new a(e[40], 1290863460), new a(e[41], 3158454273), new a(e[42], 3505952657), new a(e[43], 106217008), new a(e[44], 3606008344), new a(e[45], 1432725776), new a(e[46], 1467031594), new a(e[47], 851169720), new a(e[48], 3100823752), new a(e[49], 1363258195), new a(e[50], 3750685593), new a(e[51], 3785050280), new a(e[52], 3318307427), new a(e[53], 3812723403), new a(e[54], 2003034995), new a(e[55], 3602036899), new a(e[56], 1575990012), new a(e[57],
        1125592928), new a(e[58], 2716904306), new a(e[59], 442776044), new a(e[60], 593698344), new a(e[61], 3733110249), new a(e[62], 2999351573), new a(e[63], 3815920427), new a(3391569614, 3928383900), new a(3515267271, 566280711), new a(3940187606, 3454069534), new a(4118630271, 4000239992), new a(116418474, 1914138554), new a(174292421, 2731055270), new a(289380356, 3203993006), new a(460393269, 320620315), new a(685471733, 587496836), new a(852142971, 1086792851), new a(1017036298, 365543100), new a(1126000580, 2618297676), new a(1288033470,
        3409855158), new a(1501505948, 4234509866), new a(1607167915, 987167468), new a(1816402316, 1246189591)];
    W = [new a(0, 1), new a(0, 32898), new a(2147483648, 32906), new a(2147483648, 2147516416), new a(0, 32907), new a(0, 2147483649), new a(2147483648, 2147516545), new a(2147483648, 32777), new a(0, 138), new a(0, 136), new a(0, 2147516425), new a(0, 2147483658), new a(0, 2147516555), new a(2147483648, 139), new a(2147483648, 32905), new a(2147483648, 32771), new a(2147483648, 32770), new a(2147483648, 128), new a(0, 32778), new a(2147483648,
        2147483658), new a(2147483648, 2147516545), new a(2147483648, 32896), new a(0, 2147483649), new a(2147483648, 2147516424)];
    V = [
        [0, 36, 3, 41, 18],
        [1, 44, 10, 45, 2],
        [62, 6, 43, 15, 61],
        [28, 55, 25, 21, 56],
        [27, 20, 39, 8, 14]
    ];
    "function" === typeof define && define.amd ? define(function() {
        return C
    }) : "undefined" !== typeof exports ? ("undefined" !== typeof module && module.exports && (module.exports = C), exports = C) : X.jsSHA = C
})(this);



// =========== END HMAC ===========

</script> 
<style>

.smallHeader {
  	/* font-weight: bold; */
  	font-size: 14pt;
  	color: #22d;
 	font-family:Georgia, serif;
}


</style>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="./encryptiondecryptiontool_1.0.0-2018_files/jquery.mobile-1.4.5.min.css">

<script src="./encryptiondecryptiontool_1.0.0-2018_files/jquery-1.11.3.min.js.download"></script>

<script src="./encryptiondecryptiontool_1.0.0-2018_files/jquery.mobile-1.4.5.min.js.download"></script>
<title></title></head>

<body style="background-color:#dfded0;" class="ui-mobile-viewport ui-overlay-a"><div data-role="page" data-url="/hosted-files/tools/encryptiondecryptiontool.html" tabindex="0" class="ui-page ui-page-theme-a ui-page-active" style="min-height: 768px;">
<div data-role="main" class="ui-content">
<div style="font-family:calibri,Georgia,Times,serif+condensed;color:#25e;font-size:22pt;">Encrypt/Decrypt Tool</div>
<div style="font-family:calibri,sans-serif;font-size:9.0pt;">Version 1.0.0.
<br>Copyright 2016-2017 ID TECH.
<div style="font-family:Courier,Courier New,monospace;font-size:10pt; word-wrap: break-word;" id="verboseOutput"></div></div><br>

<div class="ui-select"><div id="selection-button" class="ui-btn ui-icon-carat-d ui-btn-icon-right ui-corner-all ui-shadow"><span>What would you like to do?</span><select id="selection">
<option value="">What would you like to do?</option>
<option value="encrypt">Encrypt or decrypt data</option>
<option value="hmac">Generate HMAC</option>
<option value="hmacVerbose">Generate HMAC (with verbose output)</option>
<option value="sha1">Generate SHA-1 Hash</option>
<option value="sha256">Generate SHA-256 Hash</option>
<option value="ipek">Generate IPEK from BDK</option>
<option value="pek">Derive key from IPEK and KSN</option>
</select></div></div><br>

<div class="smallHeader" id="keyheader">Key:</div>
<textarea rows="1" cols="54" id="key" data-inline="true" class="ui-input-text ui-shadow-inset ui-body-inherit ui-corner-all ui-textinput-autogrow" style="height: 52px;"></textarea>
<div align="right">
<a href="#popupCalc" data-rel="popup" data-position-to="window" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-gear ui-btn-icon-left ui-btn-a" data-transition="pop" style="font-size: 9pt; padding: 7px 40px; visibility: hidden;" id="derive" aria-haspopup="true" aria-owns="popupCalc" aria-expanded="false"> Derive . . .</a>
<!--<a href="https://www.idtechproducts.com/hosted-files/tools/encryptiondecryptiontool.html#popupCalc" data-rel="popup" data-position-to="window" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-gear ui-btn-icon-left ui-btn-a" data-transition="pop" style="font-size: 9pt; padding: 7px 40px; visibility: hidden;" id="derive" aria-haspopup="true" aria-owns="popupCalc" aria-expanded="false"> Derive . . .</a>-->

<div style="display: none;" id="popupCalc-placeholder"><!-- placeholder for popupCalc --></div>
</div>
<br>
<div class="smallHeader" id="dataheader">Data:</div><textarea rows="2" cols="54" id="data" class="ui-input-text ui-shadow-inset ui-body-inherit ui-corner-all ui-textinput-autogrow" style="height: 52px;"></textarea>
<div class="smallHeader" id="outputheader">Output:</div><textarea rows="4" cols="54" id="output" class="ui-input-text ui-shadow-inset ui-body-inherit ui-corner-all ui-textinput-autogrow" style="height: 52px;"></textarea>

<button id="encryptButton" data-inline="true" data-role="button" data-theme="b" class=" ui-btn ui-btn-b ui-btn-inline ui-shadow ui-corner-all"> Encrypt </button>
<button id="decryptButton" data-inline="true" data-role="button" class=" ui-btn ui-btn-inline ui-shadow ui-corner-all"> Decrypt </button>
<div id="modeControl"><div class="ui-checkbox"><label class="ui-btn ui-corner-all ui-btn-inherit ui-btn-icon-left ui-checkbox-off">
<span style="font-family:calibri,sans-serif;font-size:9.9pt;vertical-align:10%;">
<b>Use AES</b></span>
</label><input type="checkbox" id="encryptionMode" data-inline="true"></div></div>
<br>
<button id="clearButton" data-mini="true" data-role="button" class=" ui-btn ui-shadow ui-corner-all ui-mini"> Clear All </button>
</div>

<div class="ui-screen-hidden ui-popup-screen ui-overlay-inherit" id="popupCalc-screen"></div><div class="ui-popup-container ui-popup-hidden ui-popup-truncate" id="popupCalc-popup"><div data-role="popup" id="popupCalc" data-theme="a" class="ui-corner-all ui-popup ui-body-a ui-overlay-shadow" style="width:360px;">
<div style="padding:8px 8px;">
<h3>BDK and KSN:</h3>
<label for="xyz" class="ui-hidden-accessible">BDK:</label>
<div class="ui-input-text ui-body-a ui-corner-all ui-shadow-inset"><input type="text" name="user" id="dBDK" value="0123456789ABCDEFFEDCBA9876543210" placeholder="BDK" data-theme="a"></div>
<label for="abc" class="ui-hidden-accessible">KSN:</label>
<div class="ui-input-text ui-body-a ui-corner-all ui-shadow-inset"><input type="text" name="pass" id="dKSN" value="" placeholder="KSN" data-theme="a"></div>
<div class="ui-select"><div id="keyvariant-button" class="ui-btn ui-icon-carat-d ui-btn-icon-right ui-corner-all ui-shadow"><span>Data Key Variant</span><select id="keyvariant">
<option value="datakey">Data Key Variant</option>
<option value="pinkey">PIN Key Variant</option>
<option value="mackey">MAC Key Variant</option>
</select></div></div>
<button id="dCalc" class="ui-btn ui-btn-b ui-icon-check ui-btn-icon-left ui-shadow ui-corner-all">Derive Key</button>
</div>
</div></div></div><div class="ui-loader ui-corner-all ui-body-a ui-loader-default"><span class="ui-icon-loading"></span><h1>loading</h1></div></body></html>